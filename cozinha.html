<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- BLOQUEAR ZOOM -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Tarefas â€“ Cozinha</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    overscroll-behavior-y: contain;
}

/* HEADER */
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:20;
}
.header img{
    width:46px;height:46px;border-radius:50%;object-fit:cover;
}
.header-name{font-size:18px;font-weight:700;}
.status-line{font-size:13px;color:#999;margin-top:2px;}
.status-online{color:#007aff;}

/* LISTA */
.chat-area{
    padding:16px;
    padding-bottom:250px;
    overflow-y:auto;
    height:calc(100vh - 90px);
    position:relative;
}
.date-badge{
    width:fit-content;
    margin:12px auto;
    background:#d9d9d9;
    padding:6px 14px;
    border-radius:8px;
    font-size:13px;
    color:#444;
    font-weight:500;
}

/* MENSAGENS */
.msg-box{
    background:#fff;
    border-radius:10px;
    padding:12px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,.15);
    margin-bottom:10px;
    position:relative;
    transition:transform .2s;
}

.msg-user{
    background:#dcf8c6;
    margin-left:auto;
}

.msg-citacao{
    font-size:12px;
    color:#555;
    border-left:3px solid #007aff;
    padding-left:6px;
    margin-bottom:6px;
}
.msg-img{
    width:100%;
    border-radius:10px;
    margin-top:8px;
}

/* SIM/NÃƒO */
.options-box{
    background:#fff;
    border-radius:10px;
    padding:10px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,.15);
    margin-bottom:22px;
}
.btn-row{display:flex;gap:10px;}
.option-btn{
    flex:1;
    background:#f0f0f0;
    color:#555;
    border-radius:10px;
    padding:12px;
    text-align:center;
    cursor:pointer;
    user-select:none;
    position:relative;
}
.option-btn.green{background:#c8f7d4;color:#0a8f47;font-weight:600;}
.option-btn.red{background:#f7c8c8;color:#c62828;font-weight:600;}

/* SWIPE */
.reply-hint{
    position:absolute;
    left:-40px;
    top:50%;
    transform:translateY(-50%);
    opacity:0;
    transition:.2s;
    font-size:20px;
    color:#007aff;
}

/* CAIXA RESPOSTA */
#responderBox{
    position:fixed;
    bottom:0;left:0;
    width:100%;
    padding:12px;
    background:white;
    display:none;
    border-top:1px solid #ccc;
    z-index:50;
}
#responderTopo{
    display:flex;
    justify-content:space-between;
    margin-bottom:6px;
}
#citacaoTexto{font-size:13px;font-weight:600;color:#007aff;}
#cancelarResp{color:#ff3b30;font-size:15px;cursor:pointer;}
#responderInput{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
}
#responderSend{
    margin-top:8px;
    background:#007aff;
    color:white;
    padding:12px;
    border-radius:10px;
    text-align:center;
    font-size:16px;
}

/* FOTO */
#fotoBox{
    position:fixed;
    bottom:0;left:0;
    width:100%;
    background:white;
    border-top:1px solid #ccc;
    padding:15px;
    display:none;
    z-index:60;
}
#btnFoto{
    background:#007aff;
    padding:14px;
    border-radius:10px;
    text-align:center;
    color:white;
    cursor:pointer;
    font-size:16px;
}
#previewFoto{
    width:160px;
    border-radius:12px;
    margin-top:12px;
    display:none;
}

</style>
</head>

<body>

<div class="header">
    <img src="icons/cozinha.png">
    <div>
        <div class="header-name">Cozinha</div>
        <div id="statusSetor" class="status-line">Carregandoâ€¦</div>
    </div>
</div>

<div class="chat-area" id="tarefasBox"></div>

<!-- RESPOSTA -->
<div id="responderBox">
    <div id="responderTopo">
        <div id="citacaoTexto"></div>
        <div id="cancelarResp">âœ•</div>
    </div>
    <input id="responderInput" placeholder="Digite sua respostaâ€¦">
    <div id="responderSend">Enviar</div>
</div>

<!-- FOTO -->
<div id="fotoBox">
    <div id="fotoMsg" style="margin-bottom:8px;">Esta tarefa exige foto obrigatÃ³ria.</div>
    <div id="btnFoto">ðŸ“· Tirar Foto</div>
    <img id="previewFoto">
</div>

<script>
/* CONFIG */
const SETOR = "Cozinha";
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx7MG7s-SxFqbg8sTouCfd3kUxxv8D2ADOrkLUaFQgpOi1OERzb9H4BysGiTkPp6U26hw/exec";
const usuario = JSON.parse(localStorage.getItem("usuarioLogado")||"{}").nome || "UsuÃ¡rio";

let tarefaAtual = null;
let citacaoAtual = "";

/* ========== GERAR HTML ========== */
function gerarHTML(t){
    let html = "";

    // ComentÃ¡rios existentes
    if(t.comentarios){
        t.comentarios.split("\n").forEach(c=>{
            html += `
            <div class="msg-box msg-user">
                <div class="msg-citacao">${c}</div>
            </div>`;
        });
    }

    // Foto existente
    if(t.fotoURL){
        html += `
        <div class="msg-box msg-user">
            <img src="${t.fotoURL}" class="msg-img">
        </div>
        `;
    }

    // Mensagem original
    html += `
    <div class="msg-box" data-id="${t.id}">
        <div class="reply-hint">â†©</div>
        <div>${t.tarefa}</div>
        <div class="msg-time">${t.conclusao ? "ðŸ•˜ "+t.conclusao : ""}</div>
    </div>

    <div class="options-box">
        <div class="btn-row">
            <div class="option-btn ${t.status==="sim"?"green":""}" onclick="marcarSim(${t.id},'${t.fotoObrigatoria}')">Sim</div>
            <div class="option-btn ${t.status==="nao"?"red":""}" onclick="marcarNao(${t.id})">NÃ£o</div>
        </div>
    </div>
    `;

    return html;
}

/* ========== SWIPE ========== */
function ativarSwipe(){
    document.querySelectorAll(".msg-box").forEach(msg=>{
        let startX=0,drag=false;

        msg.addEventListener("touchstart",e=>{
            startX=e.touches[0].clientX; drag=false;
        });

        msg.addEventListener("touchmove",e=>{
            let d=e.touches[0].clientX-startX;
            if(d>0){
                drag=true;
                msg.style.transform=`translateX(${d}px)`;
                msg.querySelector(".reply-hint").style.opacity=d>40?1:0;
            }
        });

        msg.addEventListener("touchend",()=>{
            msg.style.transform="";
            msg.querySelector(".reply-hint").style.opacity=0;

            if(drag){
                abrirResposta(msg);
            }
        });
    });
}

/* ========== ABRIR RESPOSTA ========== */
function abrirResposta(msg){
    tarefaAtual = msg.dataset.id;
    citacaoAtual = msg.innerText.trim().split("\n")[0];

    document.getElementById("citacaoTexto").textContent = `Responder: "${citacaoAtual}"`;

    document.getElementById("responderBox").style.display = "block";
    document.getElementById("fotoBox").style.display = "none";
    document.getElementById("responderInput").focus();
}

document.getElementById("cancelarResp").onclick = ()=>{
    tarefaAtual=null;
    document.getElementById("responderBox").style.display="none";
};

/* ========== ENVIAR COMENTÃRIO ========== */
document.getElementById("responderSend").onclick = async ()=>{
    const texto = document.getElementById("responderInput").value.trim();
    if(!texto || !tarefaAtual) return;

    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({
            acao:"registrarComentario",
            id:tarefaAtual,
            comentario:`${usuario}: ${texto}`
        })
    });

    location.reload();
};

/* ========== SIM / NAO ========== */
async function marcarSim(id,fotoObg){
    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({acao:"responder",id:id,resposta:"sim"})
    });

    if(fotoObg==="sim"){
        tarefaAtual = id;
        document.getElementById("fotoBox").style.display="block";
        document.getElementById("responderBox").style.display="none";
    }else{
        location.reload();
    }
}
async function marcarNao(id){
    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({acao:"responder",id:id,resposta:"nao"})
    });
    location.reload();
}

/* ========== FOTO OBRIGATÃ“RIA ========== */
document.getElementById("btnFoto").onclick=()=>{
    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.capture="environment";

    input.onchange=e=>{
        const file=e.target.files[0];
        const reader=new FileReader();

        reader.onload=async ()=>{
            const base64=reader.result.split(",")[1];

            document.getElementById("previewFoto").src=reader.result;
            document.getElementById("previewFoto").style.display="block";

            await fetch(ENDPOINT,{
                method:"POST",
                body:JSON.stringify({
                    acao:"registrarFoto",
                    id:tarefaAtual,
                    base64:base64
                })
            });

            location.reload();
        };

        reader.readAsDataURL(file);
    };

    input.click();
};

/* ========== CARREGAR INICIAL ========== */
(async ()=>{
    document.getElementById("statusSetor").textContent="Carregandoâ€¦";

    const resp = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`).then(r=>r.json());
    const box=document.getElementById("tarefasBox");

    box.innerHTML="";
    box.insertAdjacentHTML("beforeend","<div class='date-badge'>Hoje</div>");
    (resp.hoje||[]).forEach(t=>box.insertAdjacentHTML("beforeend",gerarHTML(t)));

    box.insertAdjacentHTML("beforeend","<div class='date-badge'>AmanhÃ£</div>");
    (resp.amanha||[]).forEach(t=>box.insertAdjacentHTML("beforeend",gerarHTML(t)));

    ativarSwipe();

    setTimeout(()=>{
        document.getElementById("statusSetor").textContent="Online";
        document.getElementById("statusSetor").classList.add("status-online");
    },300);
})();
</script>

</body>
</html>
