<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- BLOQUEAR ZOOM -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Tarefas â€“ Cozinha</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    overscroll-behavior-y: contain;
}

/* HEADER */
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:20;
}

.header img{
    width:46px;
    height:46px;
    border-radius:50%;
    object-fit:cover;
}

.header-name{ font-size:18px; font-weight:700; }

.status-line{
    font-size:13px;
    margin-top:2px;
    font-weight:500;
    color:#999;
}

.status-online{
    color:#007aff;
}

/* LISTA */
.chat-area{
    padding:16px;
    padding-bottom:200px;
    overflow-y:auto;
    height:calc(100vh - 90px);
    position:relative;
}

.date-badge{
    width:fit-content;
    margin:12px auto;
    background:#d9d9d9;
    padding:6px 14px;
    border-radius:8px;
    font-size:13px;
    color:#444;
    font-weight:500;
}

.msg-box{
    background:#fff;
    border-radius:10px;
    padding:12px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:10px;
    position:relative;
    transition:transform .2s;
}

.msg-user{
    background:#dcf8c6;
    margin-left:auto;
}

.msg-citacao{
    font-size:12px;
    color:#555;
    border-left:3px solid #007aff;
    padding-left:6px;
    margin-bottom:6px;
}

.msg-img{
    width:100%;
    border-radius:10px;
    margin-top:8px;
}

/* SIM/NÃƒO */
.options-box{
    background:#fff;
    border-radius:10px;
    padding:10px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:20px;
}

.btn-row{ display:flex; gap:10px; }

.option-btn{
    flex:1;
    background:#f0f0f0;
    color:#555;
    border-radius:10px;
    padding:12px;
    font-size:16px;
    text-align:center;
    cursor:pointer;
    position:relative;
    user-select:none;
}

.option-btn.green{ background:#c8f7d4 !important; color:#0a8f47 !important; }
.option-btn.red{   background:#f7c8c8 !important; color:#c62828 !important; }

.progress-bar{
    position:absolute;
    bottom:0;
    left:0;
    height:4px;
    background:#007aff;
    width:0%;
}

/* SWIPE REPLY */
.reply-hint{
    position:absolute;
    left:-50px;
    top:50%;
    transform:translateY(-50%);
    opacity:0;
    transition:.2s;
    font-size:20px;
    color:#007aff;
}

/* BARRA DE RESPOSTA */
#responderBox{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    padding:10px;
    background:#fff;
    display:none;
    border-top:1px solid #ccc;
}

#responderInput{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
}

#responderSend{
    margin-top:8px;
    background:#007aff;
    color:white;
    padding:10px;
    border-radius:10px;
    text-align:center;
}

/* PUXAR PARA ATUALIZAR */
#pullIcon{
    width:26px;
    height:26px;
    border-radius:50%;
    border:3px solid #999;
    border-top-color:transparent;
    margin:0 auto;
    margin-top:-40px;
    opacity:0;
    transition:opacity .2s, transform .2s;
}

/* FOTO OBRIGATÃ“RIA */
#fotoBox{
    padding:10px;
    background:white;
    border-top:1px solid #ccc;
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    display:none;
}

#btnFoto{
    background:#007aff;
    color:white;
    padding:12px;
    text-align:center;
    border-radius:10px;
    cursor:pointer;
}

#previewFoto{
    width:150px;
    margin-top:10px;
    display:none;
    border-radius:12px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <img src="icons/cozinha.png">
    <div>
        <div class="header-name">Cozinha</div>
        <div id="statusSetor" class="status-line">Carregandoâ€¦</div>
    </div>
</div>

<div id="pullIcon"></div>

<div class="chat-area" id="tarefasBox"></div>

<!-- Caixa de resposta -->
<div id="responderBox">
    <div id="responderCitacao" style="font-size:13px;color:#007aff;margin-bottom:6px;"></div>
    <input id="responderInput" placeholder="Digite sua respostaâ€¦">
    <div id="responderSend">Enviar</div>
</div>

<!-- Caixa de foto -->
<div id="fotoBox">
    <div id="fotoMsg" style="font-size:14px;margin-bottom:8px;"></div>
    <div id="btnFoto">ðŸ“· Tirar Foto</div>
    <img id="previewFoto">
</div>

<script>
/* ===============================
   CONFIG
================================ */
const SETOR = "Cozinha";
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx7MG7s-SxFqbg8sTouCfd3kUxxv8D2ADOrkLUaFQgpOi1OERzb9H4BysGiTkPp6U26hw/exec";
const usuario = localStorage.getItem("usuarioLogado")
      ? JSON.parse(localStorage.getItem("usuarioLogado")).nome
      : "UsuÃ¡rio";

/* Estado */
let tarefaRespondendo = null;
let citacaoTexto = "";

/* ==========================================
   Montar HTML de cada tarefa
========================================== */
function gerarHTML(t){
    let comentariosHTML = "";

    if (t.comentarios){
        const linhas = t.comentarios.split("\n");
        linhas.forEach(l=>{
            comentariosHTML += `
                <div class="msg-box msg-user">
                    <div class="msg-citacao">${l}</div>
                </div>`;
        });
    }

    let fotoHTML = "";
    if (t.fotoURL){
        fotoHTML = `
            <div class="msg-box msg-user">
                <img class="msg-img" src="${t.fotoURL}">
            </div>
        `;
    }

    return `
        ${comentariosHTML}
        ${fotoHTML}

        <div class="msg-box" data-id="${t.id}">
            <div class="reply-hint">â†©</div>
            <div>${t.tarefa}</div>
            <div class="msg-time">${t.conclusao ? `ðŸ•˜ ${t.conclusao}` : ""}</div>
        </div>

        <div class="options-box">
            <div class="btn-row">

                <div class="option-btn ${t.status === "sim" ? "green" : ""}"
                     onclick="resposta(${t.id},'sim','${t.fotoObrigatoria}')">
                    Sim
                </div>

                <div class="option-btn ${t.status === "nao" ? "red" : ""}"
                     onclick="resposta(${t.id},'nao','${t.fotoObrigatoria}')">
                    NÃ£o
                </div>

            </div>
        </div>
    `;
}

/* ==========================================
   Carregar HOJE + AMANHÃƒ
========================================== */
async function carregarHojeAmanha(){
    const req = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`);
    const dados = await req.json();

    const hoje = dados.hoje || [];
    const amanha = dados.amanha || [];

    const box = document.getElementById("tarefasBox");
    box.innerHTML = "";

    box.insertAdjacentHTML("beforeend", `<div class="date-badge" id="hojeAnchor">Hoje</div>`);
    hoje.forEach(t => box.insertAdjacentHTML("beforeend", gerarHTML(t)));

    box.insertAdjacentHTML("beforeend", `<div class="date-badge">AmanhÃ£</div>`);
    amanha.forEach(t => box.insertAdjacentHTML("beforeend", gerarHTML(t)));

    adicionarSwipe();

    return dados;
}

/* ==========================================
   Carregar histÃ³rico
========================================== */
function carregarAnteriores(dados){
    const ontem = dados.ontem || [];
    const anteriores = dados.anteriores || {};
    const hojeNode = document.getElementById("hojeAnchor");

    if(ontem.length){
        hojeNode.insertAdjacentHTML("beforebegin", `<div class="date-badge">Ontem</div>`);
        ontem.forEach(t=> hojeNode.insertAdjacentHTML("beforebegin", gerarHTML(t)));
    }

    const datas = Object.keys(anteriores).sort((a,b)=>{
        return a.split("/").reverse().join("") > b.split("/").reverse().join("") ? 1 : -1;
    });

    datas.forEach(label=>{
        hojeNode.insertAdjacentHTML("beforebegin", `<div class="date-badge">${label}</div>`);
        anteriores[label].forEach(t=>{
            hojeNode.insertAdjacentHTML("beforebegin", gerarHTML(t));
        });
    });

    adicionarSwipe();
}

/* ==========================================
   SIM / NÃƒO
========================================== */
async function resposta(id,tipo,fotoObrigatoria){
    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({
            acao:"responder",
            id:id,
            resposta:tipo
        })
    });

    if(fotoObrigatoria === "sim" && tipo === "sim"){
        tarefaRespondendo = id;
        document.getElementById("fotoMsg").innerText = "Esta tarefa exige registro de mÃ­dia.";
        document.getElementById("fotoBox").style.display = "block";
    }else{
        location.reload();
    }
}

/* ==========================================
   SWIPE PARA RESPONDER
========================================== */
function adicionarSwipe(){
    const msgs = document.querySelectorAll(".msg-box");

    msgs.forEach(msg=>{
        let startX = 0;
        let dragged = false;

        msg.addEventListener("touchstart", e=>{
            startX = e.touches[0].clientX;
            dragged = false;
        });

        msg.addEventListener("touchmove", e=>{
            let diff = e.touches[0].clientX - startX;
            if(diff > 0){
                dragged = true;
                msg.style.transform = `translateX(${diff}px)`;
                msg.querySelector(".reply-hint").style.opacity = diff > 40 ? 1 : 0;
            }
        });

        msg.addEventListener("touchend", e=>{
            msg.style.transform = "";
            msg.querySelector(".reply-hint").style.opacity = 0;

            if(dragged){
                abrirResposta(msg);
            }
        });
    });
}

/* ==========================================
   ABRIR CAIXA DE RESPOSTA
========================================== */
function abrirResposta(msg){
    tarefaRespondendo = msg.dataset.id;
    citacaoTexto = msg.childNodes[2].textContent;

    document.getElementById("responderCitacao").innerText = `Responder: â€œ${citacaoTexto}â€`;
    document.getElementById("responderBox").style.display = "block";
}

/* ==========================================
   ENVIAR RESPOSTA
========================================== */
document.getElementById("responderSend").onclick = async () => {
    const texto = document.getElementById("responderInput").value.trim();
    if(!texto) return;

    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({
            acao:"registrarComentario",
            id:tarefaRespondendo,
            usuario:usuario,
            msg:texto
        })
    });

    location.reload();
};

/* ==========================================
   TIRAR FOTO
========================================== */
document.getElementById("btnFoto").onclick = async ()=>{
    const input = document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.capture="environment";

    input.onchange = async (e)=>{
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = async ()=>{
            const base64 = reader.result.split(",")[1];

            document.getElementById("previewFoto").src = reader.result;
            document.getElementById("previewFoto").style.display="block";

            await fetch(ENDPOINT,{
                method:"POST",
                body:JSON.stringify({
                    acao:"registrarFoto",
                    id:tarefaRespondendo,
                    base64:base64
                })
            });

            location.reload();
        };

        reader.readAsDataURL(file);
    };

    input.click();
};

/* ==========================================
   PULL TO REFRESH
========================================== */
let startY = 0;
let pulling = false;

const pullIcon = document.getElementById("pullIcon");
const chat = document.getElementById("tarefasBox");

chat.addEventListener("touchstart", e=>{
    if(chat.scrollTop === 0){
        startY = e.touches[0].clientY;
        pulling = true;
    }
});

chat.addEventListener("touchmove", e=>{
    if(!pulling) return;
    let dist = e.touches[0].clientY - startY;

    if(dist > 0 && dist < 90){
        pullIcon.style.opacity = 1;
        pullIcon.style.transform = `rotate(${dist*4}deg)`;
    }
});

chat.addEventListener("touchend", async e=>{
    pullIcon.style.opacity = 0;
    pulling = false;

    const dados = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`).then(r=>r.json());
    carregarAnteriores(dados);
});

/* ==========================================
   START
========================================== */
(async ()=>{
    const status = document.getElementById("statusSetor");
    status.innerText = "Carregandoâ€¦";

    const dados = await carregarHojeAmanha();

    setTimeout(()=>{
        status.innerText = "Online";
        status.classList.add("status-online");
    },300);
})();
</script>

</body>
</html>
