<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Tarefas ‚Äì Cozinha</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    overscroll-behavior-y: contain;
}

.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}

.header img{
    width:46px;
    height:46px;
    border-radius:50%;
    object-fit:cover;
}

.header-name{
    font-size:18px;
    font-weight:700;
}

.chat-area{
    padding:16px;
    padding-bottom:140px;
    overflow-y:auto;
    height:calc(100vh - 90px);
}

.date-badge{
    width:fit-content;
    margin:12px auto 22px;
    background:#d9d9d9;
    padding:6px 14px;
    border-radius:8px;
    font-size:13px;
    color:#444;
    font-weight:500;
}

.msg-box{
    background:#fff;
    border-radius:10px;
    padding:12px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:4px;
}

.msg-time{
    font-size:11px;
    color:#777;
    text-align:right;
    margin-top:6px;
    line-height:16px;
}

.options-box{
    background:#fff;
    border-radius:10px;
    padding:10px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:20px;
}

.btn-row{
    display:flex;
    gap:10px;
}

.option-btn{
    flex:1;
    background:#f0f0f0;
    color:#555;
    border-radius:10px;
    padding:12px;
    font-size:16px;
    text-align:center;
    cursor:pointer;
    position:relative;
    user-select:none;
    overflow:hidden;
}

.option-btn.green{
    background:#c8f7d4 !important;
    color:#0a8f47 !important;
    font-weight:600;
}

.option-btn.red{
    background:#f7c8c8 !important;
    color:#c62828 !important;
    font-weight:600;
}

.progress-bar{
    position:absolute;
    bottom:0;
    left:0;
    height:4px;
    background:#007aff;
    width:0%;
    transition:width 0.4s linear;
}

/* √çcone de pull-to-refresh */
#pullIcon{
    width:26px;
    height:26px;
    border-radius:50%;
    border:3px solid #999;
    border-top-color:transparent;
    margin:0 auto;
    margin-top:-40px;
    opacity:0;
    transition:opacity .2s, transform .2s;
}
</style>
</head>

<body>

<div class="header">
    <img id="fotoSetor" src="icon/cozinha.png">
    <div id="nomeSetor" class="header-name">Cozinha</div>
</div>

<div id="pullIcon"></div>

<div class="chat-area" id="tarefasBox"></div>

<script>

// CONFIG
const SETOR = "Cozinha";
const ENDPOINT = "https://script.google.com/macros/s/AKfycbw5WEC9e-icOWelS0T7bksyDBw4EML9DzYCtsUajZ3hqujGVariFgNAEbv_CB7y_8Ljgg/exec";

// HTML DAS MENSAGENS
function gerarHTML(t){
    return `
        <div class="msg-box">
            <div>${t.tarefa}</div>
            <div class="msg-time">
                ${t.conclusao ? `üïò ${t.conclusao}` : ""}
            </div>
        </div>

        <div class="options-box">
            <div class="btn-row">

                <div class="option-btn ${t.status === "sim" ? "green" : ""}"
                     id="sim-${t.id}" onclick="resposta(${t.id},'sim')">
                    Sim
                    <div class="progress-bar" id="pb-sim-${t.id}"></div>
                </div>

                <div class="option-btn ${t.status === "nao" ? "red" : ""}"
                     id="nao-${t.id}" onclick="resposta(${t.id},'nao')">
                    N√£o
                    <div class="progress-bar" id="pb-nao-${t.id}"></div>
                </div>

            </div>
        </div>`;
}

// CARREGA SOMENTE HOJE / AMANH√É ‚Äî R√ÅPIDO
async function carregarHojeAmanha(){
    const req = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`);
    const dados = await req.json();

    const hoje = dados.hoje || [];
    const amanha = dados.amanha || [];

    const box = document.getElementById("tarefasBox");
    box.innerHTML = "";

    box.innerHTML += `<div class="date-badge" id="hojeAnchor">Hoje</div>`;
    hoje.forEach(t => box.innerHTML += gerarHTML(t));

    box.innerHTML += `<div class="date-badge">Amanh√£</div>`;
    amanha.forEach(t => box.innerHTML += gerarHTML(t));

    return dados;
}

// CARREGA HIST√ìRICO SOMENTE SE PUXAR PRA BAIXO
function carregarAnteriores(dados){
    const ontem = dados.ontem || [];
    const anteriores = dados.anteriores || {};
    const box = document.getElementById("tarefasBox");
    const hojeNode = document.getElementById("hojeAnchor");

    // ONTEM
    if(ontem.length){
        hojeNode.insertAdjacentHTML("beforebegin", `<div class="date-badge">Ontem</div>`);
        ontem.reverse().forEach(t=> hojeNode.insertAdjacentHTML("beforebegin", gerarHTML(t)));
    }

    // OUTROS DIAS
    const datas = Object.keys(anteriores).sort((a,b)=>{
        const pa = a.split("/").reverse().join("-");
        const pb = b.split("/").reverse().join("-");
        return pa > pb ? 1 : -1;
    });

    datas.forEach(label=>{
        hojeNode.insertAdjacentHTML("beforebegin", `<div class="date-badge">${label}</div>`);
        anteriores[label].reverse().forEach(t=>{
            hojeNode.insertAdjacentHTML("beforebegin", gerarHTML(t));
        });
    });
}

// BOT√ïES
async function resposta(id,tipo){

    let btnSim = document.getElementById(`sim-${id}`);
    let btnNao = document.getElementById(`nao-${id}`);
    let pb = document.getElementById(`pb-${tipo}-${id}`);

    btnSim.classList.remove("green","red");
    btnNao.classList.remove("green","red");

    pb.style.width = "40%";
    setTimeout(()=> pb.style.width = "100%",170);

    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({
            acao:"responder",
            id:id,
            resposta:tipo
        })
    });

    setTimeout(()=>{
        if(tipo==="sim") btnSim.classList.add("green");
        else btnNao.classList.add("red");
    },350);
}

// SISTEMA DE PULL-TO-REFRESH IGUAL INSTAGRAM
let startY = 0;
let pulling = false;

const pullIcon = document.getElementById("pullIcon");
const chat = document.getElementById("tarefasBox");

chat.addEventListener("touchstart", e=>{
    if(chat.scrollTop === 0){
        startY = e.touches[0].clientY;
        pulling = true;
    }
});

chat.addEventListener("touchmove", e=>{
    if(!pulling) return;
    let dist = e.touches[0].clientY - startY;
    if(dist > 0 && dist < 90){
        pullIcon.style.opacity = 1;
        pullIcon.style.transform = `rotate(${dist*4}deg)`;
    }
    if(dist >= 90){
        pullIcon.style.borderTopColor = "#007aff";
    }
});

chat.addEventListener("touchend", async e=>{
    pullIcon.style.opacity = 0;

    let dist = e.changedTouches[0].clientY - startY;
    pulling = false;

    if(dist >= 90){
        const dados = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`).then(r=>r.json());
        carregarAnteriores(dados);
    }
});

// INICIAR
(async ()=>{
    await carregarHojeAmanha();
})();
</script>
</body>
</html>
