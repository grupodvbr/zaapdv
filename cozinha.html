/****************************************************
 *   SISTEMA DE TAREFAS • GRUPO DV
 *   Backend para o aplicativo estilo WhatsApp
 *   → 100% compatível com datas da sua planilha
 ****************************************************/

const NOME_ABA = "tarefas";

/****************************************************
 * GET
 ****************************************************/
function doGet(e) {
  const acao = e.parameter.acao;
  const setor = e.parameter.setor;

  if (acao === "listarTudo") {
    return listarTudo(setor);
  }

  return json({ erro: "Ação GET inválida" });
}

/****************************************************
 * POST
 ****************************************************/
function doPost(e) {
  const dados = JSON.parse(e.postData.contents);
  const acao = dados.acao;

  if (acao === "responder") {
    return salvarResposta(dados);
  }

  return json({ erro: "Ação POST inválida" });
}

/****************************************************
 * JSON SAFE
 ****************************************************/
function json(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/****************************************************
 * SHEET
 ****************************************************/
function getSheet() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(NOME_ABA);
  if (!sh) throw new Error("Aba 'tarefas' não encontrada.");
  return sh;
}

/****************************************************
 * NORMALIZAR DATA (100% INFALÍVEL)
 ****************************************************/
function normalizarData(valor) {

  if (!valor) return "";

  // Caso seja objeto Date do Sheets
  if (Object.prototype.toString.call(valor) === "[object Date]" && !isNaN(valor.getTime())) {
    return Utilities.formatDate(valor, "America/Bahia", "yyyy-MM-dd");
  }

  valor = valor.toString().trim();

  // Já estiver correto
  if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
    return valor;
  }

  // DD/MM/YYYY
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
    let [d, m, y] = valor.split("/");
    return `${y}-${m}-${d}`;
  }

  // DD-MM-YYYY
  if (/^\d{2}-\d{2}-\d{4}$/.test(valor)) {
    let [d, m, y] = valor.split("-");
    return `${y}-${m}-${d}`;
  }

  // Padrões longos
  let d = new Date(valor);
  if (!isNaN(d.getTime())) {
    return Utilities.formatDate(d, "America/Bahia", "yyyy-MM-dd");
  }

  return "";
}

/****************************************************
 * LISTAR HOJE + AMANHÃ
 ****************************************************/
function listarTudo(setor) {

  const hoje = Utilities.formatDate(new Date(), "America/Bahia", "yyyy-MM-dd");
  const amanha = Utilities.formatDate(new Date(Date.now() + 86400000), "America/Bahia", "yyyy-MM-dd");

  const sh = getSheet();
  const dados = sh.getDataRange().getValues();

  let respHoje = [];
  let respAmanha = [];

  dados.slice(1).forEach(l => {
    const [id, set, tarefa, dataBruta, hora, status, obs] = l;

    const data = normalizarData(dataBruta);

    if (set == setor && data === hoje) {
      respHoje.push({ id, tarefa, hora, data, status, observacao: obs || "" });
    }

    if (set == setor && data === amanha) {
      respAmanha.push({ id, tarefa, hora, data, status, observacao: obs || "" });
    }
  });

  return json({
    hoje: respHoje,
    amanha: respAmanha
  });
}

/****************************************************
 * SALVAR RESPOSTA
 ****************************************************/
function salvarResposta(dados) {
  const sh = getSheet();
  const valores = sh.getDataRange().getValues();

  const id = Number(dados.id);
  const resposta = dados.resposta;

  for (let i = 1; i < valores.length; i++) {
    if (valores[i][0] == id) {
      sh.getRange(i + 1, 6).setValue(resposta); // Coluna F – Status
      break;
    }
  }

  return json({ ok: true });
}
