<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Tarefas – Cozinha</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

/* HEADER */
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}

.header img{
    width:46px;
    height:46px;
    border-radius:50%;
    object-fit:cover;
}

.header-name{
    font-size:18px;
    font-weight:700;
}

/* CHAT AREA */
.chat-area{
    padding:16px;
    padding-bottom:140px;
}

/* DATA */
.date-badge{
    width:fit-content;
    margin:12px auto 22px;
    background:#d9d9d9;
    padding:6px 14px;
    border-radius:8px;
    font-size:13px;
    color:#444;
    font-weight:500;
}

/* BOLHA DA TAREFA */
.msg-box{
    background:#fff;
    border-radius:10px;
    padding:12px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:4px;
}

.msg-time{
    font-size:12px;
    color:#444;
    text-align:right;
    margin-top:6px;
    line-height:1.3;
}

/* BOTÕES */
.options-box{
    background:#fff;
    border-radius:10px;
    padding:10px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:20px;
}

.btn-row{
    display:flex;
    gap:10px;
}

.option-btn{
    flex:1;
    background:#f0f0f0;
    color:#555;
    border-radius:10px;
    padding:12px;
    font-size:16px;
    text-align:center;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    user-select:none;
}

.option-btn.green{
    background:#c8f7d4 !important;
    color:#0a8f47 !important;
    font-weight:600;
}

.option-btn.red{
    background:#f7c8c8 !important;
    color:#c62828 !important;
    font-weight:600;
}

.progress-bar{
    position:absolute;
    bottom:0;
    left:0;
    height:4px;
    background:#007aff;
    width:0%;
    transition:width 0.35s linear;
}
</style>
</head>

<body>

<!-- TOP -->
<div class="header">
    <img id="fotoSetor" src="FOTO-DO-SETOR">
    <div id="nomeSetor" class="header-name">Cozinha</div>
</div>

<!-- TAREFAS -->
<div class="chat-area" id="tarefasBox">
    <div class="date-badge">Hoje</div>
</div>

<script>
const SETOR = "Cozinha";
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxDEzFcjgWvowSFOUXSqfkO5dHQgJPKebt5mvl-v0Pta4LLWMRqrCB1NIrdsg3MRjbvrA/exec";

/* FORMATAÇÃO */
function formatarDataTarefa(d){
    // yyyy-mm-dd → dd/mm/yyyy
    const [y,m,dd] = d.split("-");
    return `${dd}/${m}/${y}`;
}

function formatarHoraConclusao(dt){
    if(!dt) return "";
    const data = new Date(dt);
    const dd = String(data.getDate()).padStart(2,"0");
    const mm = String(data.getMonth()+1).padStart(2,"0");
    const hh = String(data.getHours()).padStart(2,"0");
    const min = String(data.getMinutes()).padStart(2,"0");
    return `${dd}/${mm} às ${hh}:${min}`;
}

/* BUSCAR */
async function carregarTarefas(){
    const req = await fetch(ENDPOINT + "?acao=listarTudo&setor=" + SETOR);
    const dados = await req.json();

    const hoje = dados.hoje || [];
    const amanha = dados.amanha || [];

    const box = document.getElementById("tarefasBox");

    box.innerHTML = `<div class="date-badge">Hoje</div>`;

    if(hoje.length===0){
        box.innerHTML += `<p style='text-align:center;color:#666;margin-bottom:20px;'>Nenhuma tarefa para hoje.</p>`;
    } else {
        hoje.forEach(t => box.innerHTML += gerarHTML(t));
    }

    box.innerHTML += `<div class="date-badge">Amanhã</div>`;

    if(amanha.length===0){
        box.innerHTML += `<p style='text-align:center;color:#666;'>Nenhuma tarefa para amanhã.</p>`;
    } else {
        amanha.forEach(t => box.innerHTML += gerarHTML(t));
    }

    aplicarEstados(dados);
}

/* HTML DAS TAREFAS */
function gerarHTML(t){
    const dataTarefa = formatarDataTarefa(t.data);
    const horaTarefa = t.hora || "";
    const feita = t.concluido ? formatarHoraConclusao(t.concluido) : "";

    return `
        <div class="msg-box">
            <div>${t.tarefa}</div>
            <div class="msg-time">
                ${dataTarefa} às ${horaTarefa}<br>
                ${feita ? `Feita em: ${feita}` : ""}
            </div>
        </div>

        <div class="options-box">
            <div class="btn-row">

                <div class="option-btn" id="sim-${t.id}" onclick="resposta(${t.id},'sim')">
                    Sim
                    <div class="progress-bar" id="pb-sim-${t.id}"></div>
                </div>

                <div class="option-btn" id="nao-${t.id}" onclick="resposta(${t.id},'nao')">
                    Não
                    <div class="progress-bar" id="pb-nao-${t.id}"></div>
                </div>

            </div>
        </div>
    `;
}

/* MARCAR STATUS */
function aplicarEstados(dados){
    [...dados.hoje, ...dados.amanha].forEach(t=>{
        if(t.status==="sim"){
            document.getElementById("sim-"+t.id).classList.add("green");
            document.getElementById("nao-"+t.id).classList.remove("red");
        }
        if(t.status==="nao"){
            document.getElementById("nao-"+t.id).classList.add("red");
            document.getElementById("sim-"+t.id).classList.remove("green");
        }
    });
}

/* SALVAR + ANIMAÇÃO */
async function resposta(id,tipo){
    let btnSim = document.getElementById("sim-"+id);
    let btnNao = document.getElementById("nao-"+id);

    let pb = document.getElementById("pb-"+tipo+"-"+id);

    pb.style.width="40%";
    setTimeout(()=> pb.style.width="100%",150);

    await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({
            acao:"responder",
            id:id,
            resposta:tipo
        })
    });

    if(tipo==="sim"){
        btnSim.classList.add("green");
        btnNao.classList.remove("red");
    } else {
        btnNao.classList.add("red");
        btnSim.classList.remove("green");
    }
}

carregarTarefas();
</script>

</body>
</html>
