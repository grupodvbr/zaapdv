<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Tarefas â€“ Cozinha</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    overscroll-behavior-y: contain;
}

/* ========================= HEADER ========================== */

.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}

.header img{
    width:46px;
    height:46px;
    border-radius:50%;
    object-fit:cover;
}

.header-name{
    font-size:18px;
    font-weight:700;
}

.status-line{
    font-size:13px;
    margin-top:2px;
    font-weight:500;
    color:#999;
}

.status-online{
    color:#007aff;
}

/* ========================= CHAT ========================== */

.chat-area{
    padding:16px;
    padding-bottom:190px;
    overflow-y:auto;
    height:calc(100vh - 100px);
}

.date-badge{
    width:fit-content;
    margin:20px auto;
    background:#d9d9d9;
    padding:6px 14px;
    border-radius:8px;
    font-size:13px;
    color:#444;
    font-weight:500;
}

/* Mensagem da tarefa */
.msg-box{
    background:#fff;
    border-radius:10px;
    padding:12px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:6px;
}

/* Foto enviada */
.msg-photo{
    width:75%;
    border-radius:12px;
    margin:8px 0;
    margin-left:auto;
    display:block;
}

/* ComentÃ¡rio enviado */
.msg-comment{
    font-size:16px;
    padding:10px 14px;
    background:#dcf8c6;
    border-radius:12px;
    margin-left:auto;
    max-width:78%;
    margin-bottom:6px;
}

/* SIM / NÃƒO */

.options-box{
    background:#fff;
    border-radius:10px;
    padding:10px 16px;
    max-width:78%;
    box-shadow:0 1px 1px rgba(0,0,0,0.15);
    margin-bottom:20px;
}

.btn-row{
    display:flex;
    gap:10px;
}

.option-btn{
    flex:1;
    background:#f0f0f0;
    color:#555;
    border-radius:10px;
    padding:12px;
    font-size:16px;
    text-align:center;
    cursor:pointer;
    user-select:none;
}

.option-btn.green{
    background:#c8f7d4 !important;
    color:#0a8f47 !important;
    font-weight:600;
}

.option-btn.red{
    background:#f7c8c8 !important;
    color:#c62828 !important;
    font-weight:600;
}

/* PULL REFRESH */
#pullIcon{
    width:26px;
    height:26px;
    border-radius:50%;
    border:3px solid #999;
    border-top-color:transparent;
    margin:0 auto;
    margin-top:-40px;
    opacity:0;
    transition:opacity .2s, transform .2s;
}

/* CAMERA */
#cameraBox{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:white;
    border-top:1px solid #ccc;
    padding:12px;
    display:none;
    z-index:20;
}

#previewFoto{
    width:70%;
    display:block;
    margin:auto;
    border-radius:14px;
    margin-bottom:12px;
}

.enviarBtn{
    width:100%;
    padding:12px;
    background:#007aff;
    color:white;
    border:none;
    border-radius:12px;
    font-size:17px;
    margin-bottom:10px;
}

.cancelarBtn{
    width:100%;
    padding:12px;
    background:#ddd;
    color:#222;
    border:none;
    border-radius:12px;
    font-size:17px;
}

#cameraInput{
    display:none;
}
</style>
</head>

<body>

<!-- ==================== HEADER ==================== -->
<div class="header">
    <img src="icons/cozinha.png">
    <div>
        <div class="header-name">Cozinha</div>
        <div id="statusSetor" class="status-line">Carregandoâ€¦</div>
    </div>
</div>

<div id="pullIcon"></div>

<div class="chat-area" id="tarefasBox"></div>

<!-- CAMERA -->
<div id="cameraBox">
    <img id="previewFoto">
    <button class="enviarBtn" onclick="enviarFoto()">Enviar foto</button>
    <button class="cancelarBtn" onclick="cancelarFoto()">Cancelar</button>
</div>

<input type="file" accept="image/*" capture="environment" id="cameraInput">

<script>
/* ========================= CONFIG ========================== */

const SETOR = "Cozinha";
const ENDPOINT = "https://script.google.com/macros/s/AKfycbz-tpfxWde7aKA2x9yjpdD6XOgaWJ3RAhoQ4YzQahbs5e8mjZMw9oAZkM9k-9zpAICFPg/exec";

let fotoArquivo = null;
let tarefaFoto = null;

/* ========================= GERAR HTML ========================== */

function htmlTarefa(t){

    let fotos = "";
    t.fotos.forEach(f=>{
        fotos += `<img src="${f}" class="msg-photo">`;
    });

    let comentarios = "";
    t.comentarios.forEach(c=>{
        comentarios += `<div class="msg-comment">${c}</div>`;
    });

    return `
        <div class="msg-box">${t.tarefa}<br>
            <span style="font-size:13px;color:#666">ðŸ•˜ ${t.conclusao||""}</span>
        </div>

        ${fotos}
        ${comentarios}

        <div class="options-box">
            <div class="btn-row">

                <div class="option-btn ${t.status==="sim"?"green":""}"
                     onclick="btnSim(${t.id},${t.fotoObrigatoria})">
                    Sim
                </div>

                <div class="option-btn ${t.status==="nao"?"red":""}"
                     onclick="btnNao(${t.id})">
                    NÃ£o
                </div>

            </div>
        </div>
    `;
}

/* ========================= CARREGAR ========================== */

async function carregarHojeAmanha(){
    const dados = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`).then(r=>r.json());
    const box = document.getElementById("tarefasBox");
    box.innerHTML = "";

    box.innerHTML += `<div class="date-badge" id="hojeAnchor">Hoje</div>`;
    dados.hoje.forEach(t=> box.innerHTML += htmlTarefa(t));

    box.innerHTML += `<div class="date-badge">AmanhÃ£</div>`;
    dados.amanha.forEach(t=> box.innerHTML += htmlTarefa(t));

    return dados;
}

/* ========================= HISTÃ“RICO ========================== */

function carregarAnteriores(d){
    const anchor = document.getElementById("hojeAnchor");

    d.ontem.forEach(t=>{
        anchor.insertAdjacentHTML("beforebegin", htmlTarefa(t));
    });

    Object.keys(d.anteriores).forEach(data=>{
        anchor.insertAdjacentHTML("beforebegin", `<div class="date-badge">${data}</div>`);
        d.anteriores[data].forEach(t=>{
            anchor.insertAdjacentHTML("beforebegin", htmlTarefa(t));
        });
    });
}

/* ========================= BOTÃ•ES ========================== */

function btnNao(id){
    fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({acao:"responder", id, resposta:"nao"})
    });
    carregarHojeAmanha();
}

function btnSim(id, precisaFoto){
    if(precisaFoto){
        tarefaFoto = id;
        fotoArquivo = null;
        document.getElementById("previewFoto").src = "";
        document.getElementById("cameraBox").style.display = "block";
        document.getElementById("cameraInput").click();
        return;
    }

    fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({acao:"responder", id, resposta:"sim"})
    });

    carregarHojeAmanha();
}

/* ========================= FOTO (UPLOAD REAL) ========================== */

document.getElementById("cameraInput").onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;

    fotoArquivo = file;

    const reader = new FileReader();
    reader.onload = ev=>{
        document.getElementById("previewFoto").src = ev.target.result;
        document.getElementById("previewFoto").style.display = "block";
    };
    reader.readAsDataURL(file);
};

function cancelarFoto(){
    fotoArquivo = null;
    tarefaFoto = null;
    document.getElementById("cameraBox").style.display = "none";
}

async function enviarFoto(){
    if(!fotoArquivo || !tarefaFoto) return;

    const cameraBox = document.getElementById("cameraBox");
    const preview = document.getElementById("previewFoto");

    cameraBox.style.opacity = "0.6";
    cameraBox.style.pointerEvents = "none";
    preview.style.filter = "grayscale(1)";

    try {
        // AQUI AGORA ESTÃ 100% COMPATÃVEL COM O GAS
        let fd = new FormData();
        fd.append("id", tarefaFoto);
        fd.append("setor", SETOR);
        fd.append("imagem", fotoArquivo);  // nome do campo nÃ£o importa

        const up = await fetch(ENDPOINT, {
            method: "POST",
            body: fd
        }).then(r => r.json());

        if(!up.ok){
            alert("Erro ao enviar foto");
            cameraBox.style.opacity = "1";
            cameraBox.style.pointerEvents = "auto";
            preview.style.filter = "none";
            return;
        }

        // SÃ³ depois marca como SIM
        await fetch(ENDPOINT, {
            method: "POST",
            body: JSON.stringify({
                acao: "responder",
                id: tarefaFoto,
                resposta: "sim"
            })
        });

        cancelarFoto();
        carregarHojeAmanha();

    } catch(e){
        alert("Falha ao enviar foto");
        console.log(e);
    }
}

/* ========================= PULL TO REFRESH ========================== */

let startY = 0;
let pulling = false;

const pullIcon = document.getElementById("pullIcon");
const chat = document.getElementById("tarefasBox");

chat.addEventListener("touchstart",e=>{
    if(chat.scrollTop===0){
        pulling = true;
        startY = e.touches[0].clientY;
    }
});

chat.addEventListener("touchmove",e=>{
    if(!pulling) return;
    let dist = e.touches[0].clientY - startY;
    if(dist>0 && dist<80){
        pullIcon.style.opacity = 1;
        pullIcon.style.transform = `rotate(${dist*4}deg)`;
    }
});

chat.addEventListener("touchend",async e=>{
    pullIcon.style.opacity = 0;
    if(!pulling) return;
    pulling = false;

    let dist = e.changedTouches[0].clientY - startY;

    if(dist>70){
        const d = await fetch(`${ENDPOINT}?acao=listarTudo&setor=${SETOR}`).then(r=>r.json());
        carregarAnteriores(d);
    }
});

/* ========================= START ========================== */

(async ()=>{
    const st = document.getElementById("statusSetor");
    st.textContent = "Carregandoâ€¦";

    await carregarHojeAmanha();

    setTimeout(()=>{
        st.textContent = "Online";
        st.classList.add("status-online");
    },300);

})();
</script>

</body>
</html>
