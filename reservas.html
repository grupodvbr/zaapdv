<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Reservas ‚Ä¢ Mercatto Del√≠cia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />

  <style>
    /* ================================================================
       MELHORIAS PARA CELULAR
    =================================================================*/
    html, body {
      margin:0;
      padding:0;
      width:100%;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
    }

    @media(max-width:480px){
      .wrap{padding:18px 14px 30px;}
      header .title{font-size:1.4rem;}
      .card-head h2{font-size:1rem;}
      input, select, textarea{font-size:16px;}
      .cal-day{min-height:95px; padding:8px;}
      .cal-day .num{font-size:.95rem;}
      .tag{font-size:.7rem; padding:3px 6px;}
      .summary-grid{grid-template-columns:1fr !important;}
      .kpi .value{font-size:1.25rem;}
    }

    /* ================================================================
       PALETA + BASE
    =================================================================*/
    :root{
      --bg:#f3f5f9; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --brand-2:#1e40af; --ok:#16a34a; --warn:#b45309; --danger:#ef4444;
      --accent:#f59e0b; --radius:16px;
      --shadow: 0 12px 30px rgba(2,6,23,.06);
      --glass: rgba(255,255,255,.6);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0e14; --card:#0f131b; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937;
        --shadow: 0 12px 30px rgba(0,0,0,.35); --glass: rgba(17,24,39,.5);
      }
    }

    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at -10% -20%, rgba(37,99,235,.08), transparent 60%),
        radial-gradient(900px 700px at 110% -10%, rgba(16,185,129,.08), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width:1180px; margin:auto; padding:28px 18px 40px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:22px}
    .title{font-size:clamp(1.4rem,3vw,2rem); font-weight:900; letter-spacing:.2px;}
    .badge{
      font-size:.82rem; background:linear-gradient(90deg,var(--brand),var(--brand-2));
      color:#fff; padding:6px 10px; border-radius:999px; box-shadow:var(--shadow)
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 18px; border-bottom:1px dashed var(--line);
      background:var(--glass); backdrop-filter:blur(6px);
    }
    .card-head h2{margin:0; font-size:1.1rem}

    .section{padding:18px}
    .section + .section{border-top:1px dashed var(--line)}
    .section h3{margin:0 0 10px; font-size:1rem; color:var(--muted); font-weight:700}

    label{font-weight:600; font-size:.95rem}
    input, select, textarea, button{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid var(--line); background:transparent; color:inherit;
      font-size:16px; outline:none; transition:.15s;
      -webkit-tap-highlight-color: transparent;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(37,99,235,.15)
    }

    .hint{font-size:.82rem; color:var(--muted)}

    .inline-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    @media(max-width:700px){
      .inline-grid{grid-template-columns:1fr}
    }

    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:0; cursor:pointer; font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff}
    .btn-ghost{background:#0000; border:1px dashed var(--line)}
    .btn-danger{background:var(--danger); color:#fff}
    footer{padding:16px 18px; display:flex; justify-content:flex-end}

    .chip{
      border:1px solid var(--line); border-radius:999px;
      padding:6px 10px; font-size:.84rem; color:var(--muted);
      background:var(--glass); backdrop-filter: blur(6px)
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="title">Reservas ‚Ä¢ Mercatto Del√≠cia</div>
      <div class="badge">Cadastro ‚Üí Calend√°rio ‚Üí Resumo</div>
    </header>

    <!-- ===========================
         FORMUL√ÅRIO
    ============================-->
    <form id="reservaForm" class="card" novalidate>
      <div class="card-head"><h2>Nova / Editar Reserva</h2></div>

      <input type="hidden" name="acao" value="cadastrar" />
      <input type="hidden" name="status" value="Pendente" />
      <input type="hidden" name="id" id="reservaId" value="" />

      <div class="section">
        <h3>üë§ Dados do Cliente</h3>

        <div class="inline-grid">
          <div>
            <label>Nome Completo *</label>
            <input id="nome" name="nome" required />
          </div>

          <div>
            <label>E-mail *</label>
            <input id="email" name="email" type="email" required />
          </div>

          <div>
            <label>Telefone *</label>
            <input id="telefone" name="telefone" type="tel" inputmode="numeric" placeholder="(99) 99999-9999" required />
            <div class="hint">WhatsApp para contato</div>
          </div>

          <div>
            <label>Pessoas *</label>
            <input id="pessoas" name="pessoas" type="number" min="1" required />
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ü™ë Detalhes da Reserva</h3>

        <div class="inline-grid">
          <div>
            <label>Local *</label>
            <select id="mesa" name="mesa" required>
              <option value="">Selecione</option>
              <option>SALA VIP</option>
              <option>SALA VIP 2</option>
              <option>SACADA</option>
              <option>SAL√ÉO CENTRAL</option>
            </select>
          </div>

          <div>
            <label>Card√°pio</label>
            <select id="cardapio" name="cardapio">
              <option value="">Selecione</option>
              <option>Buffet Ouro</option>
              <option>Buffet Diamante</option>
              <option>Buffet Master Gold</option>
              <option>Rod√≠zio Pizza</option>
              <option>Rod√≠zio Happy Hour</option>
              <option>√Ä la carte</option>
              <option>Outro</option>
            </select>
          </div>
        </div>

        <label style="margin-top:12px">Data e Hora *</label>
        <input type="datetime-local" id="datahora" name="datahora" required />
        <div class="hint">N√£o permitido escolher data passada</div>
      </div>

      <div class="section">
        <h3>üí≥ Sinal / Pagamento</h3>

        <div class="inline-grid">
          <div>
            <label>Valor Estimado</label>
            <input id="valorEstimado" name="valorEstimado" placeholder="0,00" inputmode="decimal" />
          </div>

          <div>
            <label>Adiantamento</label>
            <input id="pagamentoAntecipado" name="pagamentoAntecipado" placeholder="0,00" inputmode="decimal" />
          </div>
        </div>

        <label style="margin-top:12px">Banco do adiantamento</label>
        <select id="banco" name="banco">
          <option value="">Selecione</option>
          <option>SICREDI</option>
          <option>ITA√ö</option>
          <option>CR√âDITO POS</option>
          <option>D√âBITO POS</option>
        </select>
        <div class="hint">Obrigat√≥rio apenas se houver adiantamento</div>
      </div>

      <div class="section">
        <h3>üìù Observa√ß√µes & Comprovante</h3>
        <textarea id="observacoes" name="observacoes" placeholder="Obs gerais"></textarea>

        <label style="margin-top:12px">Comprovante (PDF/JPG)</label>
        <input id="arquivo" type="file" accept=".pdf,.jpg,.jpeg,.png" />

        <div id="fileBox" style="display:none; margin-top:8px" class="file-box">
          <div class="file-name" id="fileName"></div>
          <button type="button" id="clearFile" class="btn btn-danger" style="width:auto">Remover</button>
        </div>
      </div>

      <div class="section">
        <div class="chip">Status: <b id="statusChip">PENDENTE</b></div>
      </div>

      <footer>
        <button type="button" id="cancelEdit" class="btn btn-ghost" style="display:none">Cancelar edi√ß√£o</button>
        <button type="reset" class="btn btn-ghost">Limpar</button>
        <button type="submit" id="submitBtn" class="btn btn-primary">Salvar</button>
      </footer>

    </form>
    <!-- ======================================================
         CALEND√ÅRIO
    ======================================================= -->
    <br><br>

    <div class="card" id="calendarioCard">
      <div class="card-head">
        <h2>Calend√°rio de Reservas</h2>
        <div>
          <button type="button" class="btn btn-ghost" onclick="mesAnterior()">‚óÄ</button>
          <button type="button" class="btn btn-ghost" onclick="proximoMes()">‚ñ∂</button>
        </div>
      </div>

      <div class="section">
        <div id="mesAtualTxt" style="font-weight:700; font-size:1.1rem; margin-bottom:12px"></div>

        <div class="cal-grid" id="calGrid" 
             style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;">
        </div>
      </div>
    </div>

    <br><br>

  </div><!-- wrap -->

  <!-- ======================================================
       MODAL DE RESERVAS DO DIA
  ======================================================= -->
  <div id="modalDia" 
       style="position:fixed; top:0; left:0; width:100%; height:100%;
              background:rgba(0,0,0,.45); backdrop-filter:blur(4px);
              display:none; justify-content:center; align-items:flex-end; padding:18px;">

    <div style="background:var(--card); width:92%; max-width:480px; 
                border-radius:18px; padding:18px; max-height:80%; overflow-y:auto;">

      <div style="font-size:1.2rem; font-weight:700; margin-bottom:6px">
        Reservas em <span id="modalData"></span>
      </div>

      <div id="listaDia"></div>

      <br>
      <button class="btn btn-ghost" onclick="fecharModalDia()">Fechar</button>
    </div>
  </div>

  <!-- ======================================================
       MODAL DE CONFIRMA√á√ÉO DE EXCLUS√ÉO
  ======================================================= -->
  <div id="modalExcluir"
       style="position:fixed; inset:0; background:rgba(0,0,0,.45);
              display:none; justify-content:center; align-items:center; padding:20px;">
    
    <div style="background:var(--card); width:92%; max-width:380px; padding:20px;
                border-radius:18px; text-align:center;">
      
      <div style="font-size:1.1rem; font-weight:700; margin-bottom:12px">
        Tem certeza que deseja excluir?
      </div>

      <div class="toolbar" style="justify-content:center; margin-top:14px">
        <button class="btn btn-danger" style="width:45%" onclick="confirmarExcluir()">Excluir</button>
        <button class="btn btn-ghost" style="width:45%" onclick="cancelarExcluir()">Cancelar</button>
      </div>

    </div>
  </div>

  <!-- ======================================================
       JAVASCRIPT
  ======================================================= -->
  <script>
    const ENDPOINT =
      "https://script.google.com/macros/s/AKfycbxrChhbUWBoGXyWL-iIVvU8GgIxpPvVeg2U_79pBDxsqJBWg5N9vOFYEHcRlx4jII9P/exec";

    let anoAtual, mesAtual;
    let reservaExcluirId = null;

    document.addEventListener("DOMContentLoaded", () => {
      initCalendario();
      configurarForm();
    });

    /* ============================================================
       FORMUL√ÅRIO
    ============================================================ */
    function configurarForm(){
      const form = document.getElementById("reservaForm");

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();

        const fd = new FormData(form);

        // Upload de arquivo se existir
        const arquivo = document.getElementById("arquivo").files[0];
        if(arquivo){
          fd.append("arquivo", arquivo);
        }

        const req = await fetch(ENDPOINT, { method:"POST", body:fd });
        const json = await req.json();

        if(json.ok){
          alert("Reserva salva!");
          form.reset();
          document.getElementById("fileBox").style.display = "none";
          gerarCalendario();
        } else {
          alert("Erro: "+json.erro);
        }
      });

      // mostrar nome do arquivo
      document.getElementById("arquivo").addEventListener("change", ()=>{
        const arq = document.getElementById("arquivo").files[0];
        if(arq){
          document.getElementById("fileBox").style.display = "block";
          document.getElementById("fileName").textContent = arq.name;
        }
      });

      // limpar arquivo
      document.getElementById("clearFile").addEventListener("click", ()=>{
        document.getElementById("arquivo").value = "";
        document.getElementById("fileBox").style.display = "none";
      });
    }

    /* ============================================================
       CALEND√ÅRIO
    ============================================================ */
    function initCalendario(){
      const hoje = new Date();
      anoAtual = hoje.getFullYear();
      mesAtual = hoje.getMonth();
      gerarCalendario();
    }

    function mesAnterior(){
      mesAtual--;
      if(mesAtual < 0){
        mesAtual = 11;
        anoAtual--;
      }
      gerarCalendario();
    }

    function proximoMes(){
      mesAtual++;
      if(mesAtual > 11){
        mesAtual = 0;
        anoAtual++;
      }
      gerarCalendario();
    }

    async function gerarCalendario(){
      const grid = document.getElementById("calGrid");
      const txt = document.getElementById("mesAtualTxt");

      grid.innerHTML = "";

      const meses = [
        "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
        "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
      ];
      txt.textContent = `${meses[mesAtual]} de ${anoAtual}`;

      const primeiroDia = new Date(anoAtual, mesAtual, 1);
      const ultimoDia = new Date(anoAtual, mesAtual+1, 0);
      const inicioSemana = primeiroDia.getDay();

      const totalDias = ultimoDia.getDate();

      // obter reservas do m√™s
      const r = await fetch(`${ENDPOINT}?acao=listarMes&ano=${anoAtual}&mes=${mesAtual+1}`);
      const dados = await r.json();
      const mapa = dados.mapa || {};

      // espa√ßos em branco at√© o primeiro dia
      for(let i=0;i<inicioSemana;i++){
        const div = document.createElement("div");
        grid.appendChild(div);
      }

      // Dias do m√™s
      for(let dia=1; dia<=totalDias; dia++){
        const datakey = `${anoAtual}-${String(mesAtual+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;

        const div = document.createElement("div");
        div.className = "cal-day";
        div.style.minHeight = "90px";
        div.style.padding = "8px";
        div.style.borderRadius = "12px";
        div.style.background = "var(--card)";
        div.style.border = "1px solid var(--line)";
        div.style.cursor = "pointer";
        div.style.boxShadow = "var(--shadow)";

        div.innerHTML = `
          <div class="num" style="font-weight:700; margin-bottom:6px">${dia}</div>
        `;

        if(mapa[datakey]){
          mapa[datakey].forEach(res=>{
            div.innerHTML += `<div class="tag" style="background:var(--brand); color:#fff;
                               margin-bottom:3px; border-radius:6px; padding:3px 6px;
                               font-size:.75rem">${res.nome}</div>`;
          });
        }

        div.onclick = ()=>abrirDia(datakey);
        grid.appendChild(div);
      }
    }

    /* ============================================================
       MODAL DIA
    ============================================================ */
    async function abrirDia(data){
      document.getElementById("modalData").textContent = data;
      document.getElementById("modalDia").style.display = "flex";

      const r = await fetch(`${ENDPOINT}?acao=listarDia&data=${data}`);
      const dados = await r.json();

      const box = document.getElementById("listaDia");
      box.innerHTML = "";

      if(!dados.reservas || dados.reservas.length === 0){
        box.innerHTML = "<p>Nenhuma reserva.</p>";
        return;
      }

      dados.reservas.forEach(res=>{
        const div = document.createElement("div");
        div.style.padding = "12px";
        div.style.border = "1px solid var(--line)";
        div.style.borderRadius = "12px";
        div.style.marginBottom = "10px";
        div.style.background = "var(--card)";

        div.innerHTML = `
          <b>${res.nome}</b><br>
          <span>${res.datahora}</span><br>
          <span>${res.mesa}</span><br>
          <div style="margin-top:8px; display:flex; gap:8px">
            <button class="btn btn-primary" style="flex:1" onclick='editar(${JSON.stringify(res)})'>Editar</button>
            <button class="btn btn-danger" style="flex:1" onclick="excluir(${res.id})">Excluir</button>
          </div>
        `;

        box.appendChild(div);
      });
    }

    function fecharModalDia(){
      document.getElementById("modalDia").style.display = "none";
    }

    /* ============================================================
       EDITAR RESERVA
    ============================================================ */
    function editar(res){
      fecharModalDia();

      document.getElementById("reservaId").value = res.id;
      document.getElementById("nome").value = res.nome;
      document.getElementById("email").value = res.email;
      document.getElementById("telefone").value = res.telefone;
      document.getElementById("pessoas").value = res.pessoas;
      document.getElementById("mesa").value = res.mesa;
      document.getElementById("cardapio").value = res.cardapio;
      document.getElementById("datahora").value = res.datahora;
      document.getElementById("valorEstimado").value = res.valorEstimado;
      document.getElementById("pagamentoAntecipado").value = res.pagamentoAntecipado;
      document.getElementById("banco").value = res.banco;
      document.getElementById("observacoes").value = res.observacoes;

      document.getElementById("submitBtn").textContent = "Atualizar";
      document.getElementById("cancelEdit").style.display = "inline-block";

      // status
      document.getElementById("statusChip").textContent = res.status;
      document.querySelector("[name='status']").value = res.status;
      document.querySelector("[name='acao']").value = "atualizar";
    }

    document.getElementById("cancelEdit").addEventListener("click", ()=>{
      document.getElementById("reservaForm").reset();
      document.getElementById("reservaId").value = "";
      document.querySelector("[name='acao']").value = "cadastrar";
      document.getElementById("submitBtn").textContent = "Salvar";
      document.getElementById("cancelEdit").style.display = "none";
      document.getElementById("statusChip").textContent = "PENDENTE";
    });

    /* ============================================================
       EXCLUIR RESERVA
    ============================================================ */
    function excluir(id){
      reservaExcluirId = id;
      document.getElementById("modalExcluir").style.display = "flex";
    }

    function cancelarExcluir(){
      reservaExcluirId = null;
      document.getElementById("modalExcluir").style.display = "none";
    }

    async function confirmarExcluir(){
      if(!reservaExcluirId) return;

      const fd = new FormData();
      fd.append("acao","excluir");
      fd.append("id", reservaExcluirId);

      const r = await fetch(ENDPOINT,{ method:"POST", body:fd });
      const json = await r.json();

      if(json.ok){
        alert("Exclu√≠do!");
        document.getElementById("modalExcluir").style.display = "none";
        gerarCalendario();
      } else {
        alert("Erro ao excluir");
      }

      reservaExcluirId = null;
    }
  </script>

</body>
</html>
