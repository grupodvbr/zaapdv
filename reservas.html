<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

<title>ZaapDV • Cadastrar Produto</title>

<style>
body{
  margin:0;
  background:#efeae2;
  font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}

.header img{
    width:46px; height:46px;
    border-radius:50%;
    object-fit:cover;
}

.header-title{
    font-size:22px;
    font-weight:700;
}

/* CONTEÚDO */
.page{
    padding:16px;
    padding-bottom:160px;
}

/* INPUT PADRÃO */
.input{
    width:100%;
    padding:14px;
    background:white;
    border:none;
    border-radius:14px;
    font-size:17px;
    margin-bottom:14px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
}

select.input{
    appearance:none;
}

/* FOTO */
.fotoProduto{
    width:100%;
    height:220px;
    background:#ddd;
    border-radius:14px;
    margin-bottom:16px;
    object-fit:cover;
    display:none;
}

.btnFoto{
    background:white;
    padding:12px;
    border-radius:14px;
    text-align:center;
    font-size:17px;
    font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    cursor:pointer;
    margin-bottom:16px;
}

/* BOTÃO PRINCIPAL */
.btnSalvar{
    width:100%;
    padding:16px;
    background:#007aff;
    color:white;
    font-size:19px;
    font-weight:700;
    text-align:center;
    border-radius:14px;
    cursor:pointer;
    box-shadow:0 4px 14px rgba(0,0,0,.2);
}

/* POPUP */
#popup{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,.4);
  z-index:20;
}

.popup-box{
  width:85%;
  max-width:350px;
  background:white;
  padding:22px;
  border-radius:16px;
  text-align:center;
  animation:fade .25s ease;
}

@keyframes fade{
  from{ opacity:0; transform:scale(.95);}
  to{ opacity:1; transform:scale(1);}
}

.popup-title{
  font-size:20px;
  font-weight:700;
  margin-bottom:14px;
}

.popup-btn{
  background:#007aff;
  color:white;
  padding:12px;
  border-radius:14px;
  margin-top:12px;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img src="https://i.imgur.com/0ZQZQYx.png">
  <div class="header-title">Cadastrar Produto</div>
</div>

<!-- PAGE -->
<div class="page">

  <img id="fotoPreview" class="fotoProduto">

  <div class="btnFoto" onclick="document.getElementById('fotoInput').click()">
    Selecionar Foto
  </div>

  <input type="file" id="fotoInput" accept="image/*" style="display:none">

  <input id="nome" class="input" placeholder="Nome do produto">
  <input id="categoria" class="input" placeholder="Categoria">

  <select id="condicao" class="input">
    <option value="">Condição</option>
    <option value="novo">Novo</option>
    <option value="usado">Usado</option>
  </select>

  <input id="preco" class="input" placeholder="Preço (Ex: 129.90)">
  <input id="precoPromo" class="input" placeholder="Preço promocional (opcional)">
  
  <textarea id="descricao" class="input" placeholder="Descrição do produto" rows="4"></textarea>

  <div class="btnSalvar" onclick="salvarProduto()">
    Cadastrar Produto
  </div>

</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-box">
    <div class="popup-title">Produto cadastrado!</div>
    <div class="popup-btn" onclick="fecharPopup()">Fechar</div>
  </div>
</div>

<script type="module">
import { supa } from "./src/supabase.js";

/* FOTO PREVIEW */
document.getElementById("fotoInput").onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const prev = document.getElementById("fotoPreview");
  prev.src = URL.createObjectURL(file);
  prev.style.display = "block";
};

/* SALVAR PRODUTO */
window.salvarProduto = async function(){

  const nome = document.getElementById("nome").value.trim();
  const categoria = document.getElementById("categoria").value.trim();
  const condicao = document.getElementById("condicao").value;
  const preco = Number(document.getElementById("preco").value.replace(",", "."));
  const precoPromo = Number(document.getElementById("precoPromo").value.replace(",", "."));
  const descricao = document.getElementById("descricao").value.trim();

  const file = document.getElementById("fotoInput").files[0];

  if(!file){ alert("Selecione uma foto"); return; }
  if(!nome){ alert("Informe o nome do produto"); return; }
  if(!categoria){ alert("Informe a categoria"); return; }
  if(!condicao){ alert("Informe a condição"); return; }
  if(!preco){ alert("Informe o preço"); return; }

  /* UPLOAD DA IMAGEM */
  const filePath = `produtos/${Date.now()}_${file.name}`;
  const { error: upErr } = await supa.storage
    .from("produtos")
    .upload(filePath, file);

  if(upErr){
    alert("Erro ao enviar foto");
    console.log(upErr);
    return;
  }

  const { data: publicURL } = supa.storage
    .from("produtos")
    .getPublicUrl(filePath);

  /* SALVAR PRODUTO NO BANCO */
  const { data, error } = await supa
    .from("produtos")
    .insert({
      nome,
      categoria,
      condicao,
      preco,
      preco_promocional: precoPromo > 0 ? precoPromo : null,
      descricao,
      imagens: [ publicURL.publicUrl ]
    })
    .select()
    .single();

  if(error){
    alert("Erro ao salvar produto");
    console.log(error);
    return;
  }

  /* MOSTRAR POPUP */
  document.getElementById("popup").style.display = "flex";

  /* LIMPAR CAMPOS */
  document.getElementById("nome").value = "";
  document.getElementById("categoria").value = "";
  document.getElementById("condicao").value = "";
  document.getElementById("preco").value = "";
  document.getElementById("precoPromo").value = "";
  document.getElementById("descricao").value = "";
  document.getElementById("fotoPreview").style.display = "none";
};

/* FECHAR POPUP */
window.fecharPopup = function(){
  document.getElementById("popup").style.display = "none";
};
</script>

</body>
</html>
