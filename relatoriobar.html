<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>Relatório do Bar</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

/* HEADER FIXO */
.header{
    position:fixed;
    top:0; left:0; right:0;
    height:80px;
    padding:14px 16px;
    background:#ffffff;
    border-bottom:1px solid #d5d5d5;
    display:flex;
    align-items:center;
    gap:12px;
    z-index:10;
}
.header img{
    width:50px; height:50px; border-radius:50%;
}
.header-info{
    display:flex;
    flex-direction:column;
}
.header-title{
    font-size:20px;
    font-weight:700;
}
.header-sub{
    margin-top:2px;
    font-size:13px;
    color:#777;
}

/* CONTENT AREA */
.area{
    padding:100px 16px 20px;
}

/* CARD */
.dia{
    background:white;
    padding:14px;
    border-radius:12px;
    margin-bottom:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
    cursor:pointer;
}
.dif-negativo{color:#e74c3c;font-weight:700;}
.dif-positivo{color:#2ecc71;font-weight:700;}

/* POPUP */
.popup{
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.55);
    display:none;
    justify-content:center;
    align-items:flex-end;
    padding:0 0 20px;
}
.popup-box{
    background:white;
    width:100%;
    max-width:480px;
    border-radius:14px 14px 0 0;
    max-height:88vh;
    overflow-y:auto;
    padding:18px;
}

/* Data estilo WhatsApp */
.data-chat{
    text-align:center;
    background:#d9d7d6;
    padding:6px 14px;
    border-radius:10px;
    font-size:13px;
    color:#555;
    margin:14px auto;
    width:max-content;
}

/* Bolha */
.msg-box{
    background:white;
    padding:16px;
    border-radius:12px;
    box-shadow:0 2px 4px rgba(0,0,0,0.18);
    font-size:16px;
    line-height:1.55;
    position:relative;
    white-space:pre-line;
}
.msg-date{
    position:absolute;
    bottom:6px;
    right:10px;
    font-size:12px;
    color:#777;
}
.vermais{
    color:#3b82f6;
    font-size:14px;
    margin-top:6px;
    cursor:pointer;
}
.rodape-info{
    font-size:13px;
    text-align:center;
    color:#777;
    margin-top:10px;
}

</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <img src="icons/contagembar.png">

    <div class="header-info">
        <div class="header-title">Relatório do Bar</div>
        <div id="ultimaData" class="header-sub">Carregando…</div>
    </div>
</div>

<div class="area" id="dias">Carregando…</div>

<!-- POPUP -->
<div id="popup" class="popup">
    <div class="popup-box">
        <div id="popupMsg"></div>

        <button onclick="fecharPopup()" style="
            margin-top:20px;width:100%;padding:14px;border:none;
            border-radius:10px;background:#ddd;font-size:17px;">
            Fechar
        </button>
    </div>
</div>

<script type="module">
import { diasComContagem, registrosDoDia } from "./db.js";

const setor = "Bar";
const divDias = document.getElementById("dias");
const ultimaDataTxt = document.getElementById("ultimaData");
const popup = document.getElementById("popup");
const popupMsg = document.getElementById("popupMsg");

/* formatar dd/mm/aaaa */
function fmt(d){
    const [a,m,g] = d.split("-");
    return `${g}/${m}/${a}`;
}

/* ================================
   LISTAR DIAS + ÚLTIMA CONTAGEM
================================ */
async function carregarDias(){
    let dias = await diasComContagem(setor);
    dias = dias.sort(); // cronológico

    if(!dias.length){
        divDias.innerHTML = "<p>Nenhuma contagem registrada.</p>";
        ultimaDataTxt.textContent = "Nenhuma contagem";
        return;
    }

    // preencher ultima contagem
    const ultima = dias[dias.length-1];
    ultimaDataTxt.textContent = "Última contagem: " + fmt(ultima);

    let html = "";

    for(let i=0;i<dias.length;i++){
        const dia = dias[i];
        const ant = dias[i-1];
        let difs = 0;

        if(ant){
            const h = await registrosDoDia(dia,setor);
            const a = await registrosDoDia(ant,setor);
            h.forEach(r=>{
                const aa = a.find(x=>x.item===r.item);
                if(aa && aa.quantidade!==r.quantidade) difs++;
            });
        }

        html += `
        <div class="dia" onclick="abrirPopup('${dia}')">
            <div>${fmt(dia)}</div>
            <div>${difs>0?`<span class='dif-negativo'>-${difs}</span>`:""}</div>
        </div>`;
    }

    divDias.innerHTML = html;
}
carregarDias();


/* ================================
   POPUP WHATSAPP
================================ */
window.abrirPopup = async function(dia){

    const hoje = await registrosDoDia(dia,setor);

    const antData = new Date(new Date(dia).getTime() - 86400000)
        .toISOString().split("T")[0];
    const ant = await registrosDoDia(antData,setor);

    let texto = "RELATÓRIO DA CONTAGEM DO DIA:\n\n";

    hoje.forEach(r=>{
        const a = ant.find(x=>x.item===r.item);
        let difTxt = "";
        if(a){
            const dif = r.quantidade - a.quantidade;
            if(dif>0) difTxt = ` (+${dif})`;
            if(dif<0) difTxt = ` (${dif})`;
        }
        texto += `• ${r.item}: ${r.quantidade}${difTxt}\n`;
    });

    popupMsg.innerHTML = `
        <div class="data-chat">${fmt(dia)}</div>

        <div class="msg-box">
            <div>${texto}</div>
            <div class="msg-date">${fmt(dia)}</div>
        </div>
    `;

    popup.style.display="flex";
};

window.fecharPopup = function(){
    popup.style.display="none";
};

</script>

</body>
</html>
