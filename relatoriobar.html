<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Relat√≥rio do Bar</title>

<style>
body{
    margin:0;
    background:#ece5dd; /* fundo WhatsApp */
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

/****************************
   CABE√áALHO WHATSAPP
*****************************/
.header{
    background:#075E54;
    color:white;
    padding:14px;
    display:flex;
    align-items:center;
}
.header img{
    width:40px; height:40px;
    border-radius:50%;
    margin-right:12px;
}
.header-title{
    font-size:18px;
    font-weight:600;
}

/****************************
   DATA DO CHAT
*****************************/
.data-chat{
    text-align:center;
    margin:20px auto;
    background:#e2dfdc;
    color:#555;
    padding:6px 14px;
    border-radius:10px;
    font-size:14px;
    width:max-content;
}

/****************************
   BOLHA DE MENSAGEM
*****************************/
.msg-box{
    background:white;
    margin:0 auto 20px auto;
    width:92%;
    padding:18px;
    border-radius:12px;
    font-size:16px;
    line-height:1.55;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    white-space:pre-line;
}
.item{
    display:flex;
    align-items:center;
    margin-bottom:5px;
}
.item span{
    margin-left:6px;
}

/****************************
   DIFEREN√áAS
*****************************/
.dif-plus{ color:#2ecc71; font-weight:600; }
.dif-minus{ color:#e74c3c; font-weight:600; }

/****************************
   RODAP√â DISCRETO
*****************************/
.rodape-info{
    text-align:center;
    margin-top:10px;
    font-size:13px;
    color:#777;
}
</style>
</head>

<body>

<div class="header">
    <img src="icons/contagembar.png">
    <div class="header-title">Relat√≥rio do Bar</div>
</div>

<div id="container"></div>

<script type="module">
import { diasComContagem, registrosDoDia } from "./db.js";

const setor = "Bar";
const container = document.getElementById("container");

/******** FORMATADOR ********/
const fmt = (d)=> {
    const [ano,mes,dia] = d.split("-");
    return `${dia}/${mes}/${ano}`;
};

/*********** EXECUTAR ***********/
(async ()=>{

    let dias = await diasComContagem(setor);
    dias = dias.sort();

    if(dias.length === 0){
        container.innerHTML = "<p style='padding:16px;'>Nenhuma contagem registrada.</p>";
        return;
    }

    const ultimaData = dias[dias.length - 1];
    const penultimaData = dias[dias.length - 2] ?? null;

    const ultima = await registrosDoDia(ultimaData, setor);
    const penultima = penultimaData ? await registrosDoDia(penultimaData, setor) : [];

    const totalMes = dias.filter(d => d.startsWith(ultimaData.slice(0,7))).length;

    /********** CABE√áALHO DE DATA **********/
    container.innerHTML += `
        <div class="data-chat">${fmt(ultimaData)}</div>
    `;

    /********** MENSAGEM WHATSAPP **********/
    let html = `BOM DIA!\nSEGUEM AS INFORMA√á√ïES DA √öLTIMA CONTAGEM:\n\n`;

    ultima.forEach(reg => {

        const ant = penultima.find(a => a.item === reg.item);
        let difTxt = "";
        let difClass = "";

        if(ant){
            const dif = reg.quantidade - ant.quantidade;

            if(Math.abs(dif) >= 1){
                if(dif > 0){
                    difTxt = ` (+${dif})`;
                    difClass = "dif-plus";
                } else {
                    difTxt = ` (${dif})`;
                    difClass = "dif-minus";
                }
            }
        }

        html += `üü¢ ${reg.item} ‚Äî <span class="${difClass}">${reg.quantidade}${difTxt}</span>\n`;
    });

    html += `\nüïí HOR√ÅRIO DA CONTAGEM: ${new Date(ultima[0]?.data_hora).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`;

    container.innerHTML += `
        <div class="msg-box">${html}</div>
    `;

    /********** RODAP√â ‚Äî CONTAGENS NO M√äS **********/
    container.innerHTML += `
        <div class="rodape-info">Contagens realizadas no m√™s: ${totalMes}</div>
    `;

})();
</script>

</body>
</html>
