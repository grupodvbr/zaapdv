<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Relatório Bar – Grupo DV</title>

<style>
body{
    margin:0;
    background:#f4f4f4;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

.header{
    background:white;
    padding:18px;
    font-size:22px;
    font-weight:700;
    border-bottom:1px solid #ddd;
}

.calendario{
    padding:16px;
    display:grid;
    grid-template-columns:repeat(7, 1fr);
    gap:8px;
}

.dia{
    background:white;
    border-radius:10px;
    padding:12px;
    text-align:center;
    box-shadow:0 1px 3px rgba(0,0,0,.15);
    cursor:pointer;
    font-size:15px;
}
.dia.ok{
    background:#d9ffe0;
    color:#0a7a27;
    font-weight:700;
}

/* POPUP */
.popup{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.55);
    display:none;
    justify-content:center;
    align-items:center;
    backdrop-filter:blur(4px);
}
.box{
    background:white;
    width:92%;
    max-width:430px;
    max-height:80vh;
    padding:20px;
    border-radius:18px;
    overflow-y:auto;
}
.tituloDia{
    font-size:20px;
    font-weight:700;
    text-align:center;
    margin-bottom:10px;
}
.itemLinha{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px solid #eee;
    font-size:16px;
}
.red{ color:#d00; font-weight:700; }
.green{ color:#007a2e; font-weight:700; }
.btnFechar{
    margin-top:15px;
    padding:12px;
    background:#ddd;
    text-align:center;
    border-radius:10px;
    cursor:pointer;
}
</style>
</head>

<body>

<div class="header">Relatório de Contagem – Bar</div>

<div id="calendario" class="calendario"></div>

<!-- POPUP -->
<div id="popup" class="popup">
    <div class="box">
        <div id="tituloDia" class="tituloDia"></div>
        <div id="lista"></div>
        <div class="btnFechar" onclick="fecharPopup()">Fechar</div>
    </div>
</div>

<script type="module">
import { supa } from "./db.js";

const setor = "Bar";

/* ======================================================
   1. Buscar dias válidos (quantidade > 0)
====================================================== */
async function carregarDias(){
    console.log("➡ BUSCANDO DIAS...");

    const { data, error } = await supa
        .from("registros")
        .select("data_hora, quantidade, setor")
        .eq("setor", "Bar")
        .gt("quantidade", 0);

    console.log("DATA:", data);
    console.log("ERROR:", error);

    if(error){
        alert("Erro ao carregar dias");
        return;
    }

    const dias = new Set();

    data.forEach(r=>{
        if(r.data_hora){
            const dia = r.data_hora.split("T")[0];
            dias.add(dia);
        }
    });

    console.log("DIAS ENCONTRADOS:", [...dias]);

    montarCalendario([...dias].sort());
}


/* ======================================================
   2. Montar calendário
====================================================== */
function montarCalendario(listaDias){
    const cal = document.getElementById("calendario");
    cal.innerHTML = "";

    if(listaDias.length === 0){
        cal.innerHTML = "<p style='grid-column:span 7; text-align:center; color:#777;'>Nenhuma contagem registrada.</p>";
        return;
    }

    listaDias.forEach(dia=>{
        const [y,m,d] = dia.split("-");
        cal.innerHTML += `
            <div class="dia ok" onclick="abrirDia('${dia}')">
                ${d}/${m}
            </div>
        `;
    });
}

/* ======================================================
   3. Abrir informações do dia
====================================================== */
window.abrirDia = async function(dia){

    const atual = await buscarRegistrosPorDia(dia);

    const diaAnterior = await buscarUltimoDiaAnterior(dia);
    let anterior = [];

    if(diaAnterior){
        anterior = await buscarRegistrosPorDia(diaAnterior);
    }

    montarPopup(dia, atual, anterior);
}

/* === Buscar registros do dia === */
async function buscarRegistrosPorDia(dia){
    const { data } = await supa
        .from("registros")
        .select("item, quantidade, data_hora")
        .eq("setor", setor)
        .gt("quantidade", 0);   // IGNORA histórico

    return data.filter(r => r.data_hora.startsWith(dia));
}

/* === Buscar dia anterior === */
async function buscarUltimoDiaAnterior(diaAtual){
    const { data } = await supa
        .from("registros")
        .select("data_hora")
        .eq("setor", setor)
        .gt("quantidade", 0);

    const dias = [...new Set(
        data.map(r => r.data_hora.split("T")[0])
    )].sort();

    const idx = dias.indexOf(diaAtual);
    return idx > 0 ? dias[idx - 1] : null;
}

/* ======================================================
   4. Construir popup de comparação
====================================================== */
function montarPopup(dia, atual, anterior){
    document.getElementById("tituloDia").textContent =
        "Contagem de " + dia.split("-").reverse().join("/");

    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    const mapaAtual = {};
    const mapaAnterior = {};

    atual.forEach(r => mapaAtual[r.item] = Number(r.quantidade));
    anterior.forEach(r => mapaAnterior[r.item] = Number(r.quantidade));

    const itens = new Set([...Object.keys(mapaAtual), ...Object.keys(mapaAnterior)]);

    itens.forEach(item=>{
        const a = mapaAtual[item] || 0;
        const b = mapaAnterior[item] || 0;
        const diff = a - b;

        let cor = "";
        if(diff > 0) cor = "green";
        if(diff < 0) cor = "red";

        lista.innerHTML += `
            <div class="itemLinha">
                <span>${item}</span>
                <span class="${cor}">${diff === 0 ? "OK" : diff}</span>
            </div>
        `;
    });

    abrirPopup();
}

/* ======================================================
   POPUP
====================================================== */
function abrirPopup(){
    document.getElementById("popup").style.display = "flex";
}
window.fecharPopup = function(){
    document.getElementById("popup").style.display = "none";
};

/* ======================================================
   INICIAR
====================================================== */
carregarDias();
</script>

</body>
</html>
