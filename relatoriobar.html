<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Relatório do Bar • Grupo DV</title>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    background:#f2eee6;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}
.header{
    display:flex;
    align-items:center;
    padding:16px;
    background:#fff;
    border-bottom:1px solid #ddd;
}
.header img{
    width:46px; height:46px; border-radius:50%;
}
.header-title{
    margin-left:12px;
    font-size:20px;
    font-weight:700;
}
.status{
    font-size:13px;
    color:#444;
    margin-left:12px;
    font-weight:600;
}

#cards{
    padding:16px;
    display:flex;
    gap:10px;
    overflow-x:auto;
}
.card{
    background:white;
    padding:14px;
    border-radius:12px;
    min-width:120px;
    box-shadow:0 3px 6px rgba(0,0,0,0.15);
}
.card-title{
    font-size:13px;
    color:#777;
}
.card-value{
    font-size:22px;
    font-weight:700;
}

#dias{
    padding:16px;
}
.dia{
    background:white;
    padding:14px;
    border-radius:10px;
    margin-bottom:10px;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.dif-positivo{color:#2ecc71;font-weight:bold;}
.dif-negativo{color:#e74c3c;font-weight:bold;}

.popup{
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.6);
    display:none; justify-content:center; align-items:center;
}
.popup-box{
    background:white;
    width:90%; max-width:420px;
    padding:20px;
    border-radius:14px;
    max-height:80vh;
    overflow-y:auto;
}
.item-row{
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid #eee;
    padding:6px 0;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <img src="icons/contagembar.png">
    <div class="header-title">Relatório do Bar</div>
    <div id="status" class="status">Carregando…</div>
</div>

<!-- CARDS -->
<div id="cards">
    <div class="card">
        <div class="card-title">Última Contagem</div>
        <div id="cardUltima" class="card-value">--</div>
    </div>
    <div class="card">
        <div class="card-title">Divergências</div>
        <div id="cardDivergencias" class="card-value">0</div>
    </div>
    <div class="card">
        <div class="card-title">Sobras</div>
        <div id="cardSobras" class="card-value">0</div>
    </div>
    <div class="card">
        <div class="card-title">Perdas</div>
        <div id="cardPerdas" class="card-value">0</div>
    </div>
</div>

<!-- GRÁFICO -->
<div style="padding:16px;">
    <canvas id="grafico"></canvas>
</div>

<!-- LISTA DE DIAS -->
<div id="dias">Carregando…</div>

<!-- POPUP -->
<div id="popup" class="popup">
    <div class="popup-box">
        <h3 id="popupData"></h3>
        <div id="popupConteudo"></div>
        <button onclick="fecharPopup()">Fechar</button>
    </div>
</div>

<script type="module">
import {
    diasComContagem,
    registrosDoDia,
    ultimaContagemAntes
} from "./db.js";

const setor = "Bar";
const divDias = document.getElementById("dias");
const status = document.getElementById("status");

const cardUltima = document.getElementById("cardUltima");
const cardDivergencias = document.getElementById("cardDivergencias");
const cardSobras = document.getElementById("cardSobras");
const cardPerdas = document.getElementById("cardPerdas");

// FORMATAR DATA
function formatar(d){
    const p = d.split("-"); // yyyy-mm-dd
    return `${p[2]}/${p[1]}/${p[0]}`;
}

// ============================
// CARREGAR DIAS
// ============================
async function carregarDias() {
    const dias = await diasComContagem(setor);

    if (!dias.length) {
        divDias.innerHTML = "<p>Nenhuma contagem registrada.</p>";
        status.textContent = "Sem dados";
        return;
    }

    // Exibir última data
    const ultima = dias[dias.length - 1];
    status.textContent = formatar(ultima);
    cardUltima.textContent = formatar(ultima);

    let html = "";

    // Para o gráfico
    const labels = [];
    const valores = [];

    // Contadores gerais
    let totalDiverg = 0, totalSobras = 0, totalPerdas = 0;

    for (let i = 0; i < dias.length; i++) {
        const dia = dias[i];
        const anterior = dias[i - 1];

        const regHoje = await registrosDoDia(dia, setor);
        const totalHoje = regHoje.reduce((s, r) => s + r.quantidade, 0);

        labels.push(formatar(dia));
        valores.push(totalHoje);

        let divergencias = 0;

        if (anterior) {
            const regAnt = await registrosDoDia(anterior, setor);

            regHoje.forEach(r => {
                const ant = regAnt.find(a => a.item === r.item);
                if (ant && ant.quantidade !== r.quantidade) {
                    divergencias++;
                    if (r.quantidade > ant.quantidade) totalSobras++;
                    if (r.quantidade < ant.quantidade) totalPerdas++;
                }
            });
        }

        totalDiverg += divergencias;

        html += `
            <div class="dia" onclick="abrirPopup('${dia}')">
                <div>${formatar(dia)}</div>
                <div>${divergencias > 0 ? "<span class='dif-negativo'>-" + divergencias + "</span>" : ""}</div>
            </div>`;
    }

    // Atualizar cards
    cardDivergencias.textContent = totalDiverg;
    cardSobras.textContent = totalSobras;
    cardPerdas.textContent = totalPerdas;

    divDias.innerHTML = html;

    montarGrafico(labels, valores);
}
carregarDias();

// ============================
// GRÁFICO
// ============================
function montarGrafico(labels, valores){
    new Chart(document.getElementById("grafico"), {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Itens contados",
                data: valores,
                borderWidth: 3,
                borderColor: "#007aff",
                backgroundColor: "rgba(0,122,255,0.2)",
                tension: .3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales:{
                y:{ beginAtZero:true }
            }
        }
    });
}

// ============================
// POPUP
// ============================
window.abrirPopup = async function(dia) {
    document.getElementById("popupData").textContent = "Comparação " + formatar(dia);

    const registros = await registrosDoDia(dia, setor);
    const ontemRegs = await ultimaContagemAntes(dia, setor);

    let html = "";

    registros.forEach(r => {
        const ant = ontemRegs.find(a => a.item === r.item);
        const dif = ant ? r.quantidade - ant.quantidade : r.quantidade;

        html += `
            <div class="item-row">
                <span>${r.item}</span>
                <span class="${dif > 0 ? "dif-positivo" : dif < 0 ? "dif-negativo" : ""}">
                    ${dif}
                </span>
            </div>`;
    });

    document.getElementById("popupConteudo").innerHTML = html;
    document.getElementById("popup").style.display = "flex";
};

window.fecharPopup = function() {
    document.getElementById("popup").style.display = "none";
};
</script>

</body>
</html>
