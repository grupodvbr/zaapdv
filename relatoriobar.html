<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Relatório Bar • Grupo DV</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    margin:0;
    background:#f4f4f7;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

header{
    padding:20px;
    background:white;
    border-bottom:1px solid #ddd;
    font-size:22px;
    font-weight:700;
}

.calendar{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:8px;
    padding:16px;
}

.day{
    background:white;
    padding:14px;
    border-radius:12px;
    text-align:center;
    font-size:16px;
    box-shadow:0 2px 8px rgba(0,0,0,0.07);
    cursor:pointer;
}

.day.active{
    background:#007aff;
    color:white;
}

.popup{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.55);
    backdrop-filter:blur(4px);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:20;
}

.popup-box{
    width:92%;
    max-width:420px;
    background:white;
    padding:20px;
    border-radius:16px;
    max-height:85vh;
    display:flex;
    flex-direction:column;
}

.popup-title{
    font-size:20px;
    font-weight:700;
    margin-bottom:10px;
    text-align:center;
}

.list{
    overflow-y:auto;
    padding-right:6px;
    flex:1;
}

.item{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px solid #eee;
    font-size:16px;
}

.red{ color:#e63946; font-weight:700; }
.green{ color:#2a9d8f; font-weight:700; }
.gray{ color:#555; font-weight:600; }

.close-btn{
    margin-top:14px;
    padding:14px;
    background:#007aff;
    color:white;
    text-align:center;
    border-radius:12px;
    cursor:pointer;
}
</style>
</head>

<body>

<header>Relatório de Contagem • Bar</header>

<div id="calendar" class="calendar"></div>

<!-- POPUP -->
<div id="popup" class="popup">
    <div class="popup-box">
        <div id="popupTitle" class="popup-title"></div>

        <div id="popupList" class="list"></div>

        <div class="close-btn" onclick="fecharPopup()">Fechar</div>
    </div>
</div>

<script>
/* ===========================================================
   CONFIG SUPABASE
=========================================================== */
const SUPA_URL = "https://ckkqcxbzfkjzicvoeehw.supabase.co";
const SUPA_KEY = "sb_publishable_djiQsCSrnLUmo0iA_eNjijMw__7rfP11m";

const supa = supabase.createClient(SUPA_URL, SUPA_KEY);

/* ===========================================================
   1 — BUSCAR DIAS COM CONTAGEM
=========================================================== */
async function carregarDias() {

    const { data, error } = await supa
        .from("registros")
        .select("data_hora")
        .eq("setor", "Bar")
        .gt("quantidade", 0);

    if (error) {
        alert("Erro ao carregar dias!");
        return;
    }

    const dias = new Set();

    data.forEach(r => {
        const dia = r.data_hora.split("T")[0];
        dias.add(dia);
    });

    montarCalendario([...dias].sort());
}

/* ===========================================================
   2 — MONTAR CALENDÁRIO
=========================================================== */
function montarCalendario(listaDias) {
    const cal = document.getElementById("calendar");
    cal.innerHTML = "";

    listaDias.forEach(dia => {
        const p = document.createElement("div");
        p.className = "day active";
        p.textContent = dia.split("-")[2];
        p.onclick = () => abrirDia(dia);
        cal.appendChild(p);
    });
}

/* ===========================================================
   3 — ABRIR POPUP COM COMPARAÇÃO
=========================================================== */
async function abrirDia(diaSelecionado) {

    // BUSCAR TODAS AS CONTAGENS DO BAR
    const { data, error } = await supa
        .from("registros")
        .select("*")
        .eq("setor", "Bar")
        .gt("quantidade", 0)
        .order("data_hora", { ascending:true });

    if (error) {
        alert("Erro ao buscar detalhes!");
        return;
    }

    // FILTRAR POR DIA
    const atual = data.filter(r => r.data_hora.startsWith(diaSelecionado));

    // DESCOBRIR A CONTAGEM ANTERIOR
    const anteriores = data.filter(r => r.data_hora < atual[0].data_hora);

    let ultima = [];

    if (anteriores.length > 0) {
        const ultimoDia = anteriores[anteriores.length - 1].data_hora.split("T")[0];
        ultima = anteriores.filter(r => r.data_hora.startsWith(ultimoDia));
    }

    mostrarComparacao(diaSelecionado, atual, ultima);
}

/* ===========================================================
   4 — COMPARAR ITEM A ITEM
=========================================================== */
function mostrarComparacao(dia, atual, anterior) {

    const popup = document.getElementById("popup");
    const title = document.getElementById("popupTitle");
    const list = document.getElementById("popupList");

    title.textContent = "Comparação do dia " + dia;
    list.innerHTML = "";

    const mapaAtual = {};
    const mapaAnterior = {};

    atual.forEach(r => mapaAtual[r.item] = r.quantidade);
    anterior.forEach(r => mapaAnterior[r.item] = r.quantidade);

    const itens = new Set([...Object.keys(mapaAtual), ...Object.keys(mapaAnterior)]);

    itens.forEach(item => {
        const qtdAtual = mapaAtual[item] || 0;
        const qtdAnt = mapaAnterior[item] || 0;
        const dif = qtdAtual - qtdAnt;

        let cor = "gray";
        if (dif > 0) cor = "green";
        if (dif < 0) cor = "red";

        list.innerHTML += `
            <div class="item">
                <span>${item}</span>
                <span class="${cor}">
                    ${qtdAtual} (${dif >= 0 ? "+"+dif : dif})
                </span>
            </div>
        `;
    });

    popup.style.display = "flex";
}

/* ===========================================================
   FECHAR POPUP
=========================================================== */
function fecharPopup() {
    document.getElementById("popup").style.display = "none";
}

/* ===========================================================
   INICIAR
=========================================================== */
carregarDias();

</script>

</body>
</html>
