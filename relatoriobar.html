<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Relatório do Bar</title>

<style>
body{
    margin:0;
    background:#f2eee6;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}
.header{
    display:flex;
    align-items:center;
    padding:16px;
    background:#fff;
    border-bottom:1px solid #ddd;
}
.header img{
    width:46px; height:46px; border-radius:50%;
}
.header-title{
    margin-left:12px;
    font-size:20px;
    font-weight:700;
}
.status{
    font-size:13px;
    color:#888;
    margin-left:12px;
}
#dias{
    padding:16px;
}
.dia{
    background:white;
    padding:14px;
    border-radius:10px;
    margin-bottom:10px;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.dif-positivo{color:#2ecc71;font-weight:bold;}
.dif-negativo{color:#e74c3c;font-weight:bold;}
.popup{
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.6);
    display:none; justify-content:center; align-items:center;
}
.popup-box{
    background:white;
    width:90%; max-width:420px;
    padding:20px;
    border-radius:14px;
    max-height:80vh;
    overflow-y:auto;
}
.item-row{
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid #eee;
    padding:6px 0;
}
</style>
</head>

<body>

<div class="header">
    <img src="icons/contagembar.png">
    <div class="header-title">Relatório do Bar</div>
    <div id="status" class="status">Carregando…</div>
</div>

<div id="dias">Carregando…</div>

<!-- POPUP -->
<div id="popup" class="popup">
    <div class="popup-box">
        <h3 id="popupData"></h3>
        <div id="popupConteudo"></div>
        <button onclick="fecharPopup()">Fechar</button>
    </div>
</div>

<script type="module">
import { diasComContagem, registrosDoDia } from "./db.js";

const setor = "Bar";
const divDias = document.getElementById("dias");
const status = document.getElementById("status");

// ============================
// CARREGAR DIAS
// ============================
async function carregarDias() {
    const dias = await diasComContagem(setor);

    if (!dias.length) {
        divDias.innerHTML = "<p>Nenhuma contagem registrada.</p>";
        status.textContent = "Nenhum dado";
        return;
    }

    status.textContent = "Online";

    let html = "";

    for (let i = 0; i < dias.length; i++) {
        const dia = dias[i];
        const anterior = dias[i - 1];

        let diferencas = 0;

        if (anterior) {
            const regHoje = await registrosDoDia(dia, setor);
            const regAnt = await registrosDoDia(anterior, setor);

            regHoje.forEach(r => {
                const ant = regAnt.find(a => a.item === r.item);
                if (ant && ant.quantidade !== r.quantidade) {
                    diferencas++;
                }
            });
        }

        html += `
            <div class="dia" onclick="abrirPopup('${dia}')">
                <div>${dia}</div>
                <div>${diferencas === 0 ? "" :
                    diferencas > 0 ?
                    "<span class='dif-negativo'>-" + diferencas + "</span>" :
                    "<span class='dif-positivo'>+" + diferencas + "</span>"
                }</div>
            </div>`;
    }

    divDias.innerHTML = html;
}
carregarDias();

// ============================
// POPUP
// ============================
window.abrirPopup = async function(dia) {
    document.getElementById("popupData").textContent = "Comparação: " + dia;

    const registros = await registrosDoDia(dia, setor);
    const ontem = await registrosDoDia(
        new Date(new Date(dia).getTime() - 86400000)
            .toISOString()
            .split("T")[0],
        setor
    );

    let html = "";

    registros.forEach(r => {
        const ant = ontem.find(a => a.item === r.item);
        const dif = ant ? r.quantidade - ant.quantidade : r.quantidade;

        html += `
            <div class="item-row">
                <span>${r.item}</span>
                <span class="${dif > 0 ? "dif-positivo" : dif < 0 ? "dif-negativo" : ""}">
                    ${dif}
                </span>
            </div>`;
    });

    document.getElementById("popupConteudo").innerHTML = html;
    document.getElementById("popup").style.display = "flex";
};

window.fecharPopup = function() {
    document.getElementById("popup").style.display = "none";
};
</script>

</body>
</html>
