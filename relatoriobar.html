<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Relatório do Bar • Grupo DV</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
    --bg:#efeae2;
    --card:#ffffff;
    --line:#ddd;
    --text:#111;
    --muted:#777;
    --blue:#007aff;
    --red:#e74c3c;
    --green:#2ecc71;
}

body{
    margin:0;
    background:var(--bg);
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    overflow:hidden;
}

/* ================= HEADER ================= */
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;

    display:flex;
    align-items:center;
    gap:12px;

    background:#fff;
    border-bottom:1px solid var(--line);
    position:sticky; top:0; z-index:10;
}
.header img{
    width:46px; height:46px;
    border-radius:50%;
}
.header-title{
    font-size:20px;
    font-weight:700;
}
.header-sub{
    font-size:14px;
    color:var(--muted);
}

/* ================= AREA ================= */
.area{
    padding:16px;
    height:calc(100vh - 90px);
    overflow-y:auto;
}

/* ================= CARD DIA ================= */
.dia-card{
    background:white;
    padding:14px 16px;
    border-radius:14px;
    box-shadow:0 2px 5px rgba(0,0,0,.12);
    margin-bottom:12px;

    display:flex;
    justify-content:space-between;
    align-items:center;
}

.dia-date{
    font-size:18px;
    font-weight:700;
}
.dia-info{
    font-size:14px;
    color:var(--muted);
}

.dif-green{ color:var(--green); font-weight:700; }
.dif-red{ color:var(--red); font-weight:700; }

/* GRÁFICOS */
.grafico-card{
    background:white;
    padding:16px;
    border-radius:16px;
    box-shadow:0 2px 5px rgba(0,0,0,.12);
    margin-top:20px;
}

/* POPUP */
#popupDia{
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.45);
    display:none;
    justify-content:center;
    align-items:center;
    backdrop-filter:blur(6px);
    z-index:50;
}
.popup-box{
    width:92%; max-width:450px;
    background:white;
    border-radius:18px;
    padding:20px;
    max-height:80vh;
    display:flex; flex-direction:column;
}
.popup-title{
    font-size:22px; font-weight:700; text-align:center;
}
.popup-scroll{
    flex:1; overflow-y:auto; padding-right:6px; margin-top:12px;
}
.popup-item{
    display:flex; justify-content:space-between;
    padding:8px 0;
    border-bottom:1px solid #eee;
    font-size:16px;
}
.btn-close{
    margin-top:14px;
    padding:14px;
    border-radius:12px;
    text-align:center;
    background:#ddd;
    font-weight:700;
    cursor:pointer;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <img src="icons/contagembar.png">
    <div>
        <div class="header-title">Relatório do Bar</div>
        <div class="header-sub" id="subinfo">Carregando...</div>
    </div>
</div>

<div class="area" id="conteudo">
    <!-- Dias são carregados aqui -->
</div>

<!-- POPUP DETALHES DO DIA -->
<div id="popupDia">
    <div class="popup-box">
        <div class="popup-title" id="popupTitulo"></div>
        <div class="popup-scroll" id="popupLista"></div>
        <div class="btn-close" onclick="fecharPopup()">Fechar</div>
    </div>
</div>

<script type="module">
import { supa } from "./db.js";

/* ====================== CARREGAR DIAS ====================== */

async function carregarDias(){
    const box = document.getElementById("conteudo");
    box.innerHTML = "";

    const { data: registros } = await supa
        .from("registro")
        .select("*")
        .eq("setor", "Bar")
        .order("data", { ascending:false });

    if(!registros || registros.length === 0){
        box.innerHTML = "<p>Nenhuma contagem registrada.</p>";
        return;
    }

    document.getElementById("subinfo").textContent =
        "Última contagem: " + registros[0].data;

    // Agrupa por dia
    const dias = {};
    registros.forEach(r=>{
        if(!dias[r.data]) dias[r.data] = [];
        dias[r.data].push(r);
    });

    const diasOrd = Object.keys(dias).sort((a,b)=> new Date(b) - new Date(a));

    let listaEvolucao = [];
    let listaEvolucaoDias = [];

    for(let i=0; i<diasOrd.length; i++){
        const dia = diasOrd[i];
        const registrosDia = dias[dia];

        const total = registrosDia.reduce((s,r)=> s + Number(r.quantidade), 0);

        listaEvolucao.push(total);
        listaEvolucaoDias.push(dia);

        let difTxt = "";
        if(i < diasOrd.length-1){
            const diaAnterior = diasOrd[i+1];
            const totalAnt = dias[diaAnterior].reduce((s,r)=> s + Number(r.quantidade), 0);
            const dif = total - totalAnt;

            difTxt = dif > 0
                ? `<span class='dif-green'>+${dif}</span>`
                : `<span class='dif-red'>${dif}</span>`;
        }

        box.innerHTML += `
            <div class="dia-card" onclick="abrirPopup('${dia}')">
                <div>
                    <div class="dia-date">${dia}</div>
                    <div class="dia-info">${registrosDia.length} itens</div>
                </div>
                <div>${difTxt || ""}</div>
            </div>
        `;
    }

    gerarGraficos(listaEvolucaoDias.reverse(), listaEvolucao.reverse());
}

carregarDias();

/* ====================== POPUP DIA ====================== */

async function abrirPopup(dia){
    const { data: registros } = await supa
        .from("registro")
        .select("*")
        .eq("setor", "Bar")
        .eq("data", dia);

    document.getElementById("popupTitulo").textContent = "Dia " + dia;

    const lista = document.getElementById("popupLista");
    lista.innerHTML = "";

    registros.forEach(r=>{
        lista.innerHTML += `
            <div class="popup-item">
                <span>${r.item}</span>
                <span><b>${r.quantidade}</b></span>
            </div>
        `;
    });

    document.getElementById("popupDia").style.display = "flex";
}

window.abrirPopup = abrirPopup;
window.fecharPopup = ()=> document.getElementById("popupDia").style.display="none";


/* ====================== GRÁFICOS ====================== */

function gerarGraficos(labels, valores){
    const box = document.getElementById("conteudo");

    box.innerHTML += `
        <div class="grafico-card">
            <h3 style="margin-bottom:10px;">Evolução das Contagens</h3>
            <canvas id="grafEvo"></canvas>
        </div>
    `;

    new Chart(document.getElementById("grafEvo"), {
        type:"line",
        data:{
            labels,
            datasets:[{
                label:"Total",
                data: valores,
                borderColor:"#007aff",
                backgroundColor:"rgba(0,122,255,.25)",
                borderWidth:3,
                tension:.4,
                fill:true
            }]
        }
    });
}
</script>

</body>
</html>
