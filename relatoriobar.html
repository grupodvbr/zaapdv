<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Relatório • Contagem do Bar</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    overflow:hidden;
}
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}
.header img{
    width:46px; height:46px;
    border-radius:50%;
}
.header-title{ font-size:20px; font-weight:700; }
.header-sub{ font-size:14px; color:#777; }

.area{
    padding:16px;
    height:calc(100vh - 90px);
    overflow-y:auto;
}

/* ================= DIA CARD ================= */
.dia-card{
    background:white;
    padding:14px 16px;
    border-radius:14px;
    box-shadow:0 2px 5px rgba(0,0,0,.12);
    margin-bottom:12px;

    display:flex;
    justify-content:space-between;
    align-items:center;
}
.dia-left{}
.dia-date{ font-size:18px; font-weight:700; }
.dia-info{ font-size:14px; color:#777; }

.dif-green{ color:#2ecc71; font-weight:700; }
.dif-red{ color:#e74c3c; font-weight:700; }

/* ================= GRAFICOS ================= */
.grafico-box{
    background:white;
    padding:16px;
    border-radius:16px;
    box-shadow:0 2px 5px rgba(0,0,0,.12);
    margin-top:20px;
}

/* ================= POPUP ================= */
#popupDia{
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.45);
    display:none;
    justify-content:center;
    align-items:center;
    backdrop-filter:blur(6px);
    z-index:50;
}
.popup-box{
    width:92%; max-width:450px;
    background:white;
    padding:20px;
    border-radius:16px;
    max-height:80vh;
    display:flex;
    flex-direction:column;
}
.popup-title{
    font-size:22px; font-weight:700; text-align:center;
}
.popup-scroll{
    flex:1;
    overflow-y:auto;
    padding-right:6px;
    margin-top:12px;
}
.popup-item{
    padding:8px 0;
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid #eee;
    font-size:16px;
}
.btn-close{
    margin-top:16px;
    padding:14px;
    background:#ddd;
    border-radius:12px;
    text-align:center;
    font-weight:700;
    cursor:pointer;
}
</style>
</head>

<body>

<div class="header">
    <img src="icons/contagembar.png">
    <div>
        <div class="header-title">Relatório do Bar</div>
        <div class="header-sub" id="subinfo">Carregando…</div>
    </div>
</div>

<div class="area" id="conteudo"></div>

<!-- POPUP -->
<div id="popupDia">
    <div class="popup-box">
        <div class="popup-title" id="popupTitulo"></div>
        <div class="popup-scroll" id="popupLista"></div>
        <div class="btn-close" onclick="fecharPopup()">Fechar</div>
    </div>
</div>

<script type="module">
import { supa } from "./db.js";

/* ================= CARREGA ITENS CADASTRADOS ================= */
let totalItens = 0;

async function carregarItensBase(){
    const { data } = await supa
        .from("itens")
        .select("*")
        .eq("setor", "Bar");

    totalItens = data.length;
}

/* ================= CARREGAR DIAS ================= */
async function carregarDias(){
    await carregarItensBase();

    const conteudo = document.getElementById("conteudo");
    conteudo.innerHTML = "";

    const { data: registros } = await supa
        .from("registro")
        .select("*")
        .eq("setor", "Bar")
        .order("data", { ascending:false });

    if(!registros.length){
        conteudo.innerHTML = "<p>Nenhuma contagem registrada.</p>";
        return;
    }

    document.getElementById("subinfo").textContent =
        "Última contagem: " + registros[0].data;

    // Agrupa por dia
    const dias = {};
    registros.forEach(r=>{
        if(!dias[r.data]) dias[r.data] = [];
        dias[r.data].push(r);
    });

    const diasOrd = Object.keys(dias).sort((a,b)=> new Date(b) - new Date(a));

    let grafLabels = [];
    let grafValores = [];

    // MONTAR CARDS
    diasOrd.forEach((dia, index)=>{
        const itensPreenchidos = dias[dia].length;
        const tarefas = totalItens - itensPreenchidos;

        grafLabels.push(dia);
        grafValores.push(itensPreenchidos);

        let difTxt = "";

        if(index < diasOrd.length-1){
            const anterior = diasOrd[index+1];
            const antes = dias[anterior].length;
            const dif = itensPreenchidos - antes;

            difTxt = dif > 0
                ? `<span class='dif-green'>+${dif}</span>`
                : `<span class='dif-red'>${dif}</span>`;
        }

        conteudo.innerHTML += `
            <div class="dia-card" onclick="abrirPopup('${dia}')">
                <div class="dia-left">
                    <div class="dia-date">${dia}</div>
                    <div class="dia-info">${tarefas} tarefas pendentes</div>
                </div>
                <div>${difTxt}</div>
            </div>
        `;
    });

    gerarGrafico(grafLabels.reverse(), grafValores.reverse());
}

/* ================= POPUP DO DIA ================= */
async function abrirPopup(dia){
    const { data: registros } = await supa
        .from("registro")
        .select("*")
        .eq("setor", "Bar")
        .eq("data", dia);

    document.getElementById("popupTitulo").textContent = "Dia " + dia;

    const lista = document.getElementById("popupLista");
    lista.innerHTML = "";

    registros.forEach(r=>{
        lista.innerHTML += `
            <div class="popup-item">
                <span>${r.item}</span>
                <span><b>${r.quantidade}</b></span>
            </div>
        `;
    });

    document.getElementById("popupDia").style.display = "flex";
}
window.abrirPopup = abrirPopup;

window.fecharPopup = ()=> document.getElementById("popupDia").style.display="none";

/* ================= GRÁFICO ================= */
function gerarGrafico(labels, valores){
    const box = document.getElementById("conteudo");

    box.innerHTML += `
        <div class="grafico-box">
            <h3 style="margin-bottom:10px;font-size:18px;">Itens Preenchidos por Dia</h3>
            <canvas id="graf1"></canvas>
        </div>
    `;

    new Chart(document.getElementById("graf1"), {
        type:"line",
        data:{
            labels,
            datasets:[{
                label:"Itens preenchidos",
                data: valores,
                borderColor:"#007aff",
                backgroundColor:"rgba(0,122,255,0.25)",
                borderWidth:3,
                tension:.4,
                fill:true
            }]
        }
    });
}

carregarDias();
</script>

</body>
</html>
