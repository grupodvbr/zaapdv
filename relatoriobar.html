<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Relatório do Bar • Grupo DV</title>

<style>
/* ============================
   ESTILO DO TOPO (IGUAL AO ORIGINAL)
============================ */
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}
.header img{
    width:46px;
    height:46px;
    border-radius:50%;
    object-fit:cover;
}
.header-name{
    font-size:18px;
    font-weight:700;
}
.status-line{
    font-size:13px;
    margin-top:2px;
    font-weight:500;
    color:#999;
}

/* ============================
   ÁREA DO CONTEÚDO
============================ */
.area{
    padding:16px;
    padding-bottom:120px;
}

/* ============================
  MENSAGENS WHATSAPP
============================ */
.msg-dia {
    text-align:center;
    margin:20px 0 10px;
    font-size:13px;
    color:#666;
}

.msg-balao{
    max-width:80%;
    padding:12px 14px;
    background:white;
    border-radius:14px;
    margin-bottom:12px;
    box-shadow:0 1px 2px rgba(0,0,0,.15);
    font-size:15px;
    line-height:1.4;
    position:relative;
}

.msg-enviada{
    background:#dcf8c6;
    margin-left:auto;
    border-bottom-right-radius:4px;
}

.msg-vermais{
    margin-top:8px;
    display:inline-block;
    font-size:13px;
    color:#007aff;
    cursor:pointer;
}

/* ============================
  POPUP
============================ */
.popup{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.55);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:50;
    backdrop-filter:blur(4px);
}
.popup-box{
    width:92%;
    max-width:420px;
    background:white;
    padding:20px;
    border-radius:18px;
    max-height:80vh;
    overflow-y:auto;
}
.item-row{
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid #eee;
    padding:6px 0;
    font-size:15px;
}
.dif-pos{ color:#2ecc71; font-weight:bold; }
.dif-neg{ color:#e74c3c; font-weight:bold; }
</style>
</head>

<body>

<!-- ===================== TOPO ===================== -->
<div class="header">
    <img src="icons/contagembar.png">
    <div>
        <div class="header-name">Relatório do Bar</div>
        <div id="statusLine" class="status-line">Carregando…</div>
    </div>
</div>

<!-- ===================== ÁREA ===================== -->
<div class="area" id="listaMensagens">Carregando…</div>

<!-- ===================== POPUP ===================== -->
<div id="popup" class="popup">
    <div class="popup-box">
        <h3 id="popupData"></h3>
        <div id="popupConteudo"></div>
        <button onclick="fecharPopup()">Fechar</button>
    </div>
</div>

<script type="module">
import { diasComContagem, registrosDoDia } from "./db.js";

const setor = "Bar";
const box = document.getElementById("listaMensagens");
const statusLine = document.getElementById("statusLine");

/* ============================
   CARREGAR LISTA DE DIAS
============================ */
async function carregar(){
    const dias = await diasComContagem(setor);

    if(!dias.length){
        box.innerHTML = "<p>Nenhuma contagem registrada.</p>";
        statusLine.textContent = "Nenhuma contagem";
        return;
    }

    // Última contagem
    const ultima = dias[dias.length - 1];
    const dt = ultima.split("-").reverse().join("/");
    statusLine.textContent = "Última contagem registrada em " + dt;

    let html = "";

    // Mensagem especial da última contagem
    html += `
        <div class="msg-balao msg-enviada">
            Última contagem registrada em ${dt}
        </div>
    `;

    // Percorrer todos os dias como mensagens
    for(let i=0; i < dias.length; i++){
        const dia = dias[i];
        const anterior = dias[i-1];

        const dataBR = dia.split("-").reverse().join("/");

        html += `<div class='msg-dia'>${dataBR}</div>`;

        // pegar registros
        const hoje = await registrosDoDia(dia, setor);
        const ant = anterior ? await registrosDoDia(anterior, setor) : [];

        let divergencias = 0;
        hoje.forEach(h=>{
            const a = ant.find(x=>x.item === h.item);
            if(a && Math.abs(h.quantidade - a.quantidade) >= 3){
                divergencias++;
            }
        });

        // Criar texto da mensagem
        let texto = `Contagem realizada em ${dataBR}<br><br>`;
        texto += `Itens com diferença ≥ 3 unidades: <b>${divergencias}</b><br><br>`;
        texto += `Toque para ver detalhes completos`;

        const msgId = "msg"+i;
        html += `
            <div class="msg-balao" onclick="abrirPopup('${dia}')">
                <div id="${msgId}" class="msg-texto">${texto}</div>
            </div>
        `;
    }

    box.innerHTML = html;
}
carregar();

/* ============================
       POPUP DETALHES
============================ */
window.abrirPopup = async function(dia){
    document.getElementById("popupData").textContent =
        "Comparação da contagem de " + dia.split("-").reverse().join("/");

    const hoje = await registrosDoDia(dia, setor);
    const ontem = await registrosDoDia(
        new Date(new Date(dia).getTime() - 86400000).toISOString().split("T")[0],
        setor
    );

    let html = "";
    hoje.forEach(h=>{
        const a = ontem.find(x=>x.item === h.item);
        const dif = a ? h.quantidade - a.quantidade : h.quantidade;

        html += `
            <div class="item-row">
                <span>${h.item}</span>
                <span class="${dif>0?'dif-pos':dif<0?'dif-neg':''}">${dif}</span>
            </div>
        `;
    });

    document.getElementById("popupConteudo").innerHTML = html;
    document.getElementById("popup").style.display = "flex";
};

window.fecharPopup = () => {
    document.getElementById("popup").style.display = "none";
};
</script>

</body>
</html>
