<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">

<title>Contagem • Grupo DV</title>

<style>
body{
    margin:0;
    background:#efeae2;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
}

/* HEADER */
.header{
    height:calc(65px + env(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top));
    padding-left:16px;
    padding-right:16px;
    display:flex;
    align-items:center;
    gap:12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:10;
}

.header img{
    width:46px;
    height:46px;
    border-radius:50%;
    object-fit:cover;
}

.header-name{
    font-size:18px;
    font-weight:700;
}

.status-line{
    font-size:13px;
    margin-top:2px;
    font-weight:500;
    color:#999;
}
.status-online{
    color:#007aff;
}

/* AREA */
.area{
    padding:16px;
    padding-bottom:160px;
}

/* TITULO CATEGORIA */
.cat-title{
    font-size:18px;
    font-weight:700;
    margin-top:25px;
    margin-bottom:10px;
}

/* ITEM */
.item-box{
    background:white;
    border-radius:12px;
    padding:12px;
    margin-bottom:10px;
    box-shadow:0 1px 2px rgba(0,0,0,0.15);
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.item-label{
    font-size:16px;
}

.inputQtd{
    width:70px;
    padding:8px;
    font-size:16px;
    border-radius:8px;
    border:1px solid #ccc;
    text-align:center;
}

/* BOTÃO */
.btnSalvar{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    padding:18px;
    background:#007aff;
    color:white;
    font-size:18px;
    font-weight:700;
    text-align:center;
    border:none;
    border-radius:0;
    z-index:20;
}

/* POPUP RESUMO */
#popupResumo{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.35);
    display:none;
    justify-content:center;
    align-items:flex-end;
    padding-bottom:40px;
    z-index:50;
}

.resumo-box{
    width:92%;
    max-width:420px;
    background:white;
    padding:18px;
    border-radius:16px;
    max-height:70%;
    overflow-y:auto;
}

.resumo-titulo{
    font-size:20px;
    font-weight:700;
    margin-bottom:12px;
    text-align:center;
}

.resumo-cat{
    font-size:17px;
    font-weight:700;
    margin-top:14px;
    margin-bottom:6px;
}

.res-item{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px solid #eee;
}

.resumo-btn{
    width:100%;
    padding:12px;
    font-size:17px;
    text-align:center;
    border-radius:10px;
    margin-top:14px;
    cursor:pointer;
}

.btn-confirmar{
    background:#28a745;
    color:white;
}

.btn-fechar{
    background:#ddd;
}
</style>
</head>

<body>

<!-- ==================== HEADER ==================== -->
<div class="header">
    <img src="icons/contagembar.png">
    <div>
        <div class="header-name">Contagem de Itens</div>
        <div id="statusSetor" class="status-line">Carregando…</div>
    </div>
</div>

<div class="area" id="conteudo"></div>

<button class="btnSalvar" onclick="abrirResumo()">Salvar Contagem</button>

<!-- ==================== POPUP RESUMO ==================== -->
<div id="popupResumo">
    <div class="resumo-box">
        <div class="resumo-titulo">Resumo da Contagem</div>
        <div id="resumoLista"></div>

        <div class="resumo-btn btn-confirmar" onclick="confirmarEnvio()">Confirmar</div>
        <div class="resumo-btn btn-fechar" onclick="fecharResumo()">Fechar</div>
    </div>
</div>

<script>
/* ============================ CONFIG ============================ */

const ENDPOINT = "https://script.google.com/macros/s/AKfycbz0y5kM1wao0R3LMaJJqSStSS89CUE1LKmMXWVxyeQDGjo_fsQHav93ZXb-vfaYPqMc/exec";
const usuario = JSON.parse(localStorage.getItem("usuarioLogado"))?.nome || "Usuário";

/* ==================== CARREGAR ITENS ==================== */

async function carregarItens(){
    const box = document.getElementById("conteudo");

    const dados = await fetch(`${ENDPOINT}?acao=listarItens`).then(r=>r.json());

    if(!dados.ok){
        alert("Erro ao carregar itens");
        return;
    }

    Object.keys(dados.categorias).forEach(categoria=>{
        
        box.innerHTML += `<div class='cat-title'>${categoria}</div>`;

        dados.categorias[categoria].forEach(obj=>{
            box.innerHTML += `
            <div class="item-box">
                <div class="item-label">${obj.item}</div>
                <input type="number" class="inputQtd"
                       min="0"
                       id="qtd_${obj.item.replace(/\s+/g,'_')}">
            </div>`;
        });

    });

    document.getElementById("statusSetor").textContent = "Online";
    document.getElementById("statusSetor").classList.add("status-online");
}

carregarItens();

/* ==================== GERAR RESUMO ==================== */

function abrirResumo(){
    const lista = document.getElementById("resumoLista");
    lista.innerHTML = "";

    const inputs = document.querySelectorAll(".inputQtd");
    const categorias = {};

    inputs.forEach(inp=>{
        const valor = Number(inp.value || 0);
        if(valor > 0){
            const item = inp.id.replace("qtd_","").replace(/_/g," ");
            const categoria = pegarCategoria(item);

            if(!categorias[categoria]) categorias[categoria] = [];
            categorias[categoria].push({ item, valor });
        }
    });

    Object.keys(categorias).forEach(cat=>{
        lista.innerHTML += `<div class='resumo-cat'>${cat}</div>`;
        categorias[cat].forEach(obj=>{
            lista.innerHTML += `
                <div class="res-item">
                    <span>${obj.item}</span>
                    <span><b>${obj.valor}</b></span>
                </div>`;
        });
    });

    document.getElementById("popupResumo").style.display = "flex";
}

function fecharResumo(){
    document.getElementById("popupResumo").style.display = "none";
}

/* ==================== DESCOBRIR CATEGORIA ==================== */

function pegarCategoria(item){
    const titulos = document.querySelectorAll(".cat-title");

    for(let c of titulos){
        let categoria = c.textContent;
        let prox = c.nextElementSibling;

        while(prox && prox.classList.contains("item-box")){
            if(prox.querySelector(".item-label").textContent === item){
                return categoria;
            }
            prox = prox.nextElementSibling;
        }
    }
    return "Desconhecido";
}

/* ==================== SALVAR ==================== */

async function confirmarEnvio(){

    const registros = [];
    const inputs = document.querySelectorAll(".inputQtd");

    inputs.forEach(inp=>{
        const valor = Number(inp.value || 0);
        if(valor > 0){
            const item = inp.id.replace("qtd_","").replace(/_/g," ");
            const categoria = pegarCategoria(item);
            registros.push({ categoria, item, quantidade:valor });
        }
    });

    if(registros.length === 0){
        alert("Nenhum item informado.");
        return;
    }

    /* --- DATA AUTOMÁTICA --- */
    const agora = new Date();
    let dataReal = new Date();

    if(agora.getHours() <= 5){
        dataReal.setDate(dataReal.getDate() - 1);
    }

    const dia = dataReal.toISOString().split("T")[0];
    const hora = agora.toTimeString().slice(0,5);

    /* --- ENVIO --- */
    const req = await fetch(ENDPOINT,{
        method:"POST",
        body:JSON.stringify({
            usuario,
            data: dia,
            hora,
            registros
        })
    });

    const resp = await req.json();

    if(resp.ok){
        alert("Contagem registrada com sucesso!");
        fecharResumo();
        document.querySelectorAll(".inputQtd").forEach(i=>i.value="");
    } else {
        alert("Erro: " + resp.erro);
    }
}

</script>

</body>
</html>
