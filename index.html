<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- ZOOM BLOQUEADO -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

<title>Grupo DV</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">

<style>
/* ===========================================
   BASE GERAL
=========================================== */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:-apple-system, BlinkMacSystemFont,sans-serif;
}

/* Bloqueio total de zoom / gestos */
html, body{
  background:#ffffff;
  height:100vh;
  overflow:hidden;
  touch-action: pan-y !important; /* impede pinch-zoom */
}

/* ===========================================
   LOGIN
=========================================== */
#loginTela{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  padding:20px;
  z-index:20;
}

.login-box{
  width:100%;
  max-width:340px;
  background:#fff;
  padding:25px;
  border-radius:16px;
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}

.login-box h2{
  text-align:center;
  margin-bottom:15px;
  font-size:22px;
}

.input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
  margin-bottom:14px;
  font-size:16px;
}

.btn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#007aff;
  color:white;
  font-size:16px;
  cursor:pointer;
}

#loginErro{
  color:red;
  font-size:14px;
  margin-top:6px;
  text-align:center;
  display:none;
}


/* ===========================================
   TOPO
=========================================== */
.topbar{
  width:100%;
  height:calc(58px + env(safe-area-inset-top));
  padding:0 20px;
  padding-top:calc(10px + env(safe-area-inset-top));
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  border-bottom:1px solid #e6e6e6;
  background:#ffffff;
}

.title{
  font-size:32px;
  font-weight:700;
  margin-bottom:7px;
}

#userFotoBtn{
  width:40px;
  height:40px;
  border-radius:50%;
  overflow:hidden;
  cursor:pointer;
  margin-bottom:8px;
  border:2px solid #ddd;
}

#userFotoBtn img{
  width:100%;
  height:100%;
  object-fit:cover;
}


/* ===========================================
   POPUP PERFIL
=========================================== */
#popupPerfil{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.35);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:30;
}

.perfil-box{
  width:90%;
  max-width:330px;
  background:white;
  padding:20px;
  border-radius:16px;
  text-align:center;
}

.perfil-foto{
  width:90px; height:90px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #007aff;
  margin-bottom:12px;
}

.perfil-nome{
  font-size:20px;
  font-weight:700;
}

.perfil-cargo{
  font-size:15px;
  margin-bottom:12px;
  color:#007aff;
}

.popup-btn{
  width:100%;
  padding:10px;
  border-radius:10px;
  background:#f2f2f7;
  margin-top:10px;
  cursor:pointer;
}

#sairBtn{
  background:#ff3b30;
  color:white;
}


/* ===========================================
   FILTROS SUPERIORES
=========================================== */
.tabs-row{
    display:flex;
    padding:6px 12px;
    gap:12px;
}

.tab-btn{
    padding:6px 14px;
    background:#f2f2f7;
    border:none;
    border-radius:20px;
    font-size:14px;
    position:relative;
}

.tab-btn.active{
    background:#d7f8d1;
    color:#1d9c4d;
    font-weight:600;
}

/* Bolinha verde */
.badge{
    position:absolute;
    top:-6px;
    right:-6px;
    background:#25d366;
    color:white;
    font-size:11px;
    padding:2px 6px;
    border-radius:20px;
    font-weight:600;
}


/* ===========================================
   SETORES
=========================================== */
.page{
  height:calc(100vh - (75px + env(safe-area-inset-bottom)));
  overflow-y:auto;
  padding-top:10px;
}

.section-title{
  padding:12px 16px;
  color:#6e6e73;
  font-size:14px;
  font-weight:600;
}

.chat-item{
  display:flex; gap:14px; padding:12px 16px;
  border-bottom:1px solid #ededed;
  cursor:pointer;
}

.avatar{
  width:60px; height:60px;
  border-radius:50%;
  object-fit:cover;
}

.chat-info{ flex:1; }
.chat-title{ font-size:18px; font-weight:600; }
.chat-msg{ font-size:14px; color:#777; }


/* ===========================================
   MENU INFERIOR
=========================================== */
.bottombar{
  height:calc(75px + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);
  position:fixed; bottom:0; width:100%;
  background:white;
  border-top:1px solid #e6e6e6;
  display:flex; justify-content:space-around; align-items:center;
}

.nav-btn{
  background:none; border:none;
  display:flex; flex-direction:column;
  align-items:center; font-size:11px;
  color:#7d7d80;
}

.nav-btn.active{ color:black; }

.nav-btn img{
  width:27px; height:27px;
  margin-bottom:3px;
}
</style>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginTela">
  <div class="login-box">
    <h2>Entrar</h2>

    <input id="loginNome" class="input" placeholder="Usuário">
    <input id="loginSenha" class="input" placeholder="Senha" type="password">

    <button class="btn" onclick="fazerLogin()">Acessar</button>
    <div id="loginErro">Usuário ou senha incorretos</div>
  </div>
</div>

<!-- ================= POPUP PERFIL ================= -->
<div id="popupPerfil">
  <div class="perfil-box">
    <img id="perfilFoto" class="perfil-foto">
    <div id="perfilNome" class="perfil-nome"></div>
    <div id="perfilCargo" class="perfil-cargo"></div>

    <div id="perfilFechar" class="popup-btn">Fechar</div>
    <div id="sairBtn" class="popup-btn">Sair</div>
  </div>
</div>


<!-- ================= INTERFACE PRINCIPAL ================= -->
<header class="topbar">
  <span class="title">Grupo DV</span>

  <div id="userFotoBtn" onclick="abrirPerfil()" style="display:none">
    <img id="userFoto">
  </div>
</header>

<div class="page">

    <!-- MENU SUPERIOR -->
    <div class="tabs-row">
        <button id="tabTodas" class="tab-btn active" onclick="filtro('todas')">Todas</button>
        <button id="tabPendentes" class="tab-btn" onclick="filtro('pendentes')">
            Pendentes
            <span id="badgePendentes" class="badge" style="display:none"></span>
        </button>
        <button id="tabRecorrentes" class="tab-btn" onclick="filtro('recorrentes')">Recorrentes</button>
        <button id="tabUrgentes" class="tab-btn" onclick="filtro('urgentes')">Urgentes</button>
    </div>

    <div class="section-title">Setores com tarefas hoje</div>

    <div id="listaSetores">

        <div class="chat-item setor" data-setor="Cozinha" onclick="openSetor('cozinha.html')">
            <img src="icons/cozinha.png" class="avatar">
            <div class="chat-info">
                <div class="chat-title">Cozinha</div>
                <div id="cozinhaCount" class="chat-msg">Carregando...</div>
            </div>
        </div>

        <div class="chat-item setor" data-setor="Salão" onclick="openSetor('salao.html')">
            <img src="icons/salao.png" class="avatar">
            <div class="chat-info">
                <div class="chat-title">Salão</div>
                <div id="salaoCount" class="chat-msg">Carregando...</div>
            </div>
        </div>

        <div class="chat-item setor" data-setor="Financeiro" onclick="openSetor('financeiro.html')">
            <img src="icons/financeiro.png" class="avatar">
            <div class="chat-info">
                <div class="chat-title">Financeiro</div>
                <div id="financeiroCount" class="chat-msg">Carregando...</div>
            </div>
        </div>

    </div>
</div>

<!-- MENU -->
<nav class="bottombar">
  <button class="nav-btn"><img src="icons/agenda.png">Reuniões</button>
  <button class="nav-btn"><img src="icons/analise.png">Análise</button>
  <button class="nav-btn"><img src="icons/grupodv.png">Grupo DV</button>
  <button class="nav-btn active"><img src="icons/tarefas.png">Tarefas</button>
  <button class="nav-btn"><img src="icons/ajustes.png">Ajustes</button>
</nav>


<script>
/* ===========================================
   BLOQUEIO DE ZOOM VIA JS
=========================================== */
document.addEventListener("gesturestart", e => e.preventDefault());
document.addEventListener("gesturechange", e => e.preventDefault());
document.addEventListener("gestureend", e => e.preventDefault());
document.addEventListener("dblclick", e => e.preventDefault());

/* ===========================================
   USUÁRIOS CADASTRADOS
=========================================== */
const usuarios = [
  { id:1, nome:"Dheure", cargo:"Gerente geral", senha:"8486", foto:"icons/dheure.png" },
  { id:2, nome:"Maria Santos", cargo:"Supervisor", senha:"2025", foto:"icons/user2.png" },
];

/* ===========================================
   LOGIN
=========================================== */
function fazerLogin(){
  const nome = document.getElementById("loginNome").value.trim();
  const senha = document.getElementById("loginSenha").value.trim();

  const user = usuarios.find(u => 
     (u.nome.toLowerCase().includes(nome.toLowerCase())) &&
      u.senha === senha
  );

  if(!user){
    document.getElementById("loginErro").style.display="block";
    return;
  }

  localStorage.setItem("usuarioLogado", JSON.stringify(user));
  registrarHistorico(`${user.nome} fez login`);
  iniciarSessao();
}

function iniciarSessao(){
  const user = JSON.parse(localStorage.getItem("usuarioLogado"));
  if(!user) return;

  document.getElementById("loginTela").style.display="none";
  document.getElementById("userFotoBtn").style.display="block";
  document.getElementById("userFoto").src = user.foto;
}

iniciarSessao();

/* ===========================================
   POPUP PERFIL
=========================================== */
function abrirPerfil(){
  const u = JSON.parse(localStorage.getItem("usuarioLogado"));
  document.getElementById("perfilFoto").src = u.foto;
  document.getElementById("perfilNome").textContent = u.nome;
  document.getElementById("perfilCargo").textContent = u.cargo;
  document.getElementById("popupPerfil").style.display="flex";
}

document.getElementById("perfilFechar").onclick = () => {
  document.getElementById("popupPerfil").style.display="none";
};

document.getElementById("sairBtn").onclick = () => {
  registrarHistorico("Usuário saiu");
  localStorage.removeItem("usuarioLogado");
  location.reload();
};

/* ===========================================
   HISTÓRICO
=========================================== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwFqMdyDMkDc4qXaGzdLZ5F5EdGvSaU1kBU9BfI3n0Xn9N03V_hj4f-64gOzsyAZ2pTgg/exec";

function registrarHistorico(acao){
  const u = JSON.parse(localStorage.getItem("usuarioLogado"));
  if(!u) return;

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"registrarHistorico",
      usuario:u.nome,
      cargo:u.cargo,
      descricao:acao
    })
  });
}

/* ===========================================
   CONTADORES DE TAREFAS
=========================================== */
const setores = {
  "Cozinha": "cozinhaCount",
  "Salão": "salaoCount",
  "Financeiro": "financeiroCount"
};

const pendentesPorSetor = {};

async function carregarContadores(){
  for(let setor in setores){
    const id = setores[setor];

    try{
      const r = await fetch(`${ENDPOINT}?acao=contarPendentesIndex&setor=${setor}`);
      const json = await r.json();
      const qtd = json.pendentes ?? 0;

      pendentesPorSetor[setor] = qtd;

      document.getElementById(id).textContent =
        qtd > 0 ? `${qtd} tarefas hoje` : "Nenhuma tarefa";

    }catch{
      document.getElementById(id).textContent = "Erro";
    }
  }

  atualizarBadgePendentes();
}

carregarContadores();

/* ===========================================
   MENU / FILTRO
=========================================== */
function atualizarBadgePendentes(){
  const total = Object.values(pendentesPorSetor).filter(v=>v>0).length;

  const badge = document.getElementById("badgePendentes");
  if(total > 0){
    badge.style.display = "inline-block";
    badge.textContent = total;
  } else {
    badge.style.display = "none";
  }
}

function filtro(tipo){
  document.querySelectorAll(".tab-btn").forEach(btn=>btn.classList.remove("active"));
  
  if(tipo === "todas") document.getElementById("tabTodas").classList.add("active");
  if(tipo === "pendentes") document.getElementById("tabPendentes").classList.add("active");
  if(tipo === "recorrentes") document.getElementById("tabRecorrentes").classList.add("active");
  if(tipo === "urgentes") document.getElementById("tabUrgentes").classList.add("active");

  const setoresDOM = document.querySelectorAll(".setor");

  setoresDOM.forEach(el=>{
    const setor = el.dataset.setor;
    const qtd = pendentesPorSetor[setor] ?? 0;

    if(tipo === "todas"){
      el.style.display = "flex";
    }
    else if(tipo === "pendentes"){
      el.style.display = qtd > 0 ? "flex" : "none";
    }
    else{
      el.style.display = "none"; // futura ativação de urgentes/recorrentes
    }
  });
}

function openSetor(p){
  registrarHistorico(`Entrou no setor ${p}`);
  window.location.href = p;
}
</script>

</body>
</html>
