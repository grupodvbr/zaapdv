<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- ZOOM BLOQUEADO -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

<title>ZaapDV ‚Ä¢ Jhone</title>

<!-- =============================== -->
<!-- ICONES DO APP (TELA INICIAL) -->
<!-- =============================== -->

<link rel="apple-touch-icon" href="icons/logo.png">
<link rel="apple-touch-startup-image" href="icons/logo.png">
<link rel="icon" type="image/png" href="icons/logo.png">
<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="white">

<meta name="theme-color" content="#ffffff">

<style>
/* ===========================================
   BASE GERAL
=========================================== */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:-apple-system, BlinkMacSystemFont,sans-serif;
}

html, body{
  background:#ffffff;
  height:100vh;
  overflow:hidden;
  touch-action: pan-y !important;
}

/* ===========================================
   TOPO
=========================================== */
.topbar{
  width:100%;
  height:calc(58px + env(safe-area-inset-top));
  padding:0 20px;
  padding-top:calc(10px + env(safe-area-inset-top));
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  border-bottom:1px solid #e6e6e6;
  background:#ffffff;
}

.title{
  font-size:32px;
  font-weight:700;
  margin-bottom:7px;
}

#userFotoBtn{
  width:40px;
  height:40px;
  border-radius:50%;
  overflow:hidden;
  cursor:pointer;
  margin-bottom:8px;
  border:2px solid #ddd;
}

#userFotoBtn img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ===========================================
   POPUP PERFIL
=========================================== */
#popupPerfil{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.35);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:30;
}

.perfil-box{
  width:90%;
  max-width:330px;
  background:white;
  padding:20px;
  border-radius:16px;
  text-align:center;
}

.perfil-foto{
  width:90px; height:90px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #007aff;
  margin-bottom:12px;
}

.perfil-nome{
  font-size:20px;
  font-weight:700;
}

.perfil-cargo{
  font-size:15px;
  margin-bottom:12px;
  color:#007aff;
}

.popup-btn{
  width:100%;
  padding:10px;
  border-radius:10px;
  background:#f2f2f7;
  margin-top:10px;
  cursor:pointer;
}

#sairBtn{
  background:#ff3b30;
  color:white;
}

/* ===========================================
   FILTROS SUPERIORES
=========================================== */
.tabs-row{
    display:flex;
    padding:6px 12px;
    gap:12px;
}

.tab-btn{
    padding:6px 14px;
    background:#f2f2f7;
    border:none;
    border-radius:20px;
    font-size:14px;
    position:relative;
}

.tab-btn.active{
    background:#d7f8d1;
    color:#1d9c4d;
    font-weight:600;
}

.badge{
    position:absolute;
    top:-6px;
    right:-6px;
    background:#25d366;
    color:white;
    font-size:11px;
    padding:2px 6px;
    border-radius:20px;
    font-weight:600;
}

/* ===========================================
   SETORES
=========================================== */
.page{
  height:calc(100vh - (75px + env(safe-area-inset-bottom)));
  overflow-y:auto;
  padding-top:10px;
}

.section-title{
  padding:12px 16px;
  color:#6e6e73;
  font-size:14px;
  font-weight:600;
}

.chat-item{
  display:flex; gap:14px; padding:12px 16px;
  border-bottom:1px solid #ededed;
  cursor:pointer;
}

.avatar{
  width:60px; height:60px;
  border-radius:50%;
  object-fit:cover;
}

.chat-info{ flex:1; }
.chat-title{ font-size:18px; font-weight:600; }
.chat-msg{ font-size:14px; color:#777; }

/* ===========================================
   MENU INFERIOR
=========================================== */
.bottombar{
  height:calc(75px + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);
  position:fixed; bottom:0; width:100%;
  background:white;
  border-top:1px solid #e6e6e6;
  display:flex; justify-content:space-around; align-items:center;
}

.nav-btn{
  background:none; border:none;
  display:flex; flex-direction:column;
  align-items:center; font-size:11px;
  color:#7d7d80;
}

.nav-btn.active{ color:black; }

.nav-btn img{
  width:27px; height:27px;
  margin-bottom:3px;
}
</style>
</head>
<body>

<!-- üîí BLOQUEIO: N√ÉO PERMITE ACESSAR SEM LOGIN -->
<script>
const u = localStorage.getItem("usuarioLogado");
if(!u){
  window.location.href = "index.html";
}
</script>

<!-- ================= POPUP PERFIL ================= -->
<div id="popupPerfil">
  <div class="perfil-box">
    <img id="perfilFoto" class="perfil-foto">
    <div id="perfilNome" class="perfil-nome"></div>
    <div id="perfilCargo" class="perfil-cargo"></div>

    <div id="perfilFechar" class="popup-btn">Fechar</div>
    <div id="sairBtn" class="popup-btn">Sair</div>
  </div>
</div>

<!-- ================= INTERFACE PRINCIPAL ================= -->
<header class="topbar">
  <span class="title">ZaapDV</span>

  <div id="userFotoBtn" onclick="abrirPerfil()">
    <img id="userFoto">
  </div>
</header>

<div class="page">

    <div class="tabs-row">
        <button id="tabTodas" class="tab-btn active" onclick="filtro('todas')">Todas</button>
        <button id="tabPendentes" class="tab-btn" onclick="filtro('pendentes')">
            Pendentes
            <span id="badgePendentes" class="badge" style="display:none"></span>
        </button>
        <button id="tabRecorrentes" class="tab-btn" onclick="filtro('recorrentes')">Recorrentes</button>
        <button id="tabUrgentes" class="tab-btn" onclick="filtro('urgentes')">Urgentes</button>
    </div>

    <div class="section-title">Setores com tarefas hoje</div>

    <div id="listaSetores">

        <div class="chat-item setor" data-setor="Cozinha" onclick="openSetor('cozinha.html')">
            <img src="icons/cozinha.png" class="avatar">
            <div class="chat-info">
                <div class="chat-title">Cozinha</div>
                <div id="cozinhaCount" class="chat-msg">Carregando...</div>
            </div>
        </div>

        <div class="chat-item setor" data-setor="Sal√£o" onclick="openSetor('salao.html')">
            <img src="icons/salao.png" class="avatar">
            <div class="chat-info">
                <div class="chat-title">Sal√£o</div>
                <div id="salaoCount" class="chat-msg">Carregando...</div>
            </div>
        </div>

        <div class="chat-item setor" data-setor="Financeiro" onclick="openSetor('financeiro.html')">
            <img src="icons/financeiro.png" class="avatar">
            <div class="chat-info">
                <div class="chat-title">Financeiro</div>
                <div id="financeiroCount" class="chat-msg">Carregando...</div>
            </div>
        </div>

    </div>
</div>

<nav class="bottombar">
  <button class="nav-btn"><img src="icons/agenda.png">Reuni√µes</button>
  <button class="nav-btn"><img src="icons/analise.png">An√°lise</button>
  <button class="nav-btn"><img src="icons/grupodv.png">Grupo DV</button>
  <button class="nav-btn active"><img src="icons/tarefas.png">Tarefas</button>
  <button class="nav-btn"><img src="icons/ajustes.png">Ajustes</button>
</nav>

<script>
/* ===========================================
   CARREGAR PERFIL DO LOGIN
=========================================== */
function iniciar(){
  const u = JSON.parse(localStorage.getItem("usuarioLogado"));
  document.getElementById("userFoto").src = u.foto;
}
iniciar();

/* ===========================================
   PERFIL POPUP
=========================================== */
function abrirPerfil(){
  const u = JSON.parse(localStorage.getItem("usuarioLogado"));
  document.getElementById("perfilFoto").src = u.foto;
  document.getElementById("perfilNome").textContent = u.nome;
  document.getElementById("perfilCargo").textContent = u.cargo;
  document.getElementById("popupPerfil").style.display="flex";
}

document.getElementById("perfilFechar").onclick = () =>{
  document.getElementById("popupPerfil").style.display="none";
};

document.getElementById("sairBtn").onclick = () =>{
  localStorage.removeItem("usuarioLogado");
  window.location.href = "index.html";
};

/* ===========================================
   HIST√ìRICO
=========================================== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwFqMdyDMkDc4qXaGzdLZ5F5EdGvSaU1kBU9BfI3n0Xn9N03V_hj4f-64gOzsyAZ2pTgg/exec";

function registrar(acao){
  const u = JSON.parse(localStorage.getItem("usuarioLogado"));
  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"registrarHistorico",
      usuario:u.nome,
      cargo:u.cargo,
      descricao:acao
    })
  });
}

/* ===========================================
   CONTADORES DE TAREFAS
=========================================== */
const setores = {
  "Cozinha": "cozinhaCount",
  "Sal√£o": "salaoCount",
  "Financeiro": "financeiroCount"
};

const pendentesPorSetor = {};

async function carregarContadores(){
  for(let setor in setores){
    const id = setores[setor];

    try{
      const r = await fetch(`${ENDPOINT}?acao=contarPendentesIndex&setor=${setor}`);
      const json = await r.json();
      const qtd = json.pendentes ?? 0;

      pendentesPorSetor[setor] = qtd;

      document.getElementById(id).textContent =
        qtd > 0 ? `${qtd} tarefas hoje` : "Nenhuma tarefa";

    }catch{
      document.getElementById(id).textContent = "Erro";
    }
  }
  atualizarBadgePendentes();
}
carregarContadores();

/* ===========================================
   FILTRO
=========================================== */
function atualizarBadgePendentes(){
  const total = Object.values(pendentesPorSetor).filter(v=>v>0).length;
  const badge = document.getElementById("badgePendentes");

  if(total > 0){
    badge.style.display="inline-block";
    badge.textContent = total;
  }
  else badge.style.display="none";
}

function filtro(tipo){
  document.querySelectorAll(".tab-btn").forEach(btn=>btn.classList.remove("active"));

  if(tipo==="todas") document.getElementById("tabTodas").classList.add("active");
  if(tipo==="pendentes") document.getElementById("tabPendentes").classList.add("active");
  if(tipo==="recorrentes") document.getElementById("tabRecorrentes").classList.add("active");
  if(tipo==="urgentes") document.getElementById("tabUrgentes").classList.add("active");

  const setoresDOM = document.querySelectorAll(".setor");

  setoresDOM.forEach(el=>{
    const setor = el.dataset.setor;
    const qtd = pendentesPorSetor[setor] ?? 0;

    if(tipo === "todas"){
      el.style.display="flex";
    }
    else if(tipo === "pendentes"){
      el.style.display = qtd > 0 ? "flex" : "none";
    }
    else{
      el.style.display="none";
    }
  });
}

/* ===========================================
   ABRIR SETOR
=========================================== */
function openSetor(p){
  registrar(`Entrou no setor ${p}`);
  window.location.href = p;
}
</script>

</body>
</html>
